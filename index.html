<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MiaPlay</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Google Fonts for title customization -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@700&family=Montserrat:wght@800&family=Roboto+Condensed:wght@800&family=Bebas+Neue&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        :root {
            --primary: #2E97F2;
            --secondary: #FF0000;
            --dark: #121212;
            --darker: #0a0a0a;
            --light: #ffffff;
            --gray: #a0a0a0;
            --danger: #ff4757;
            --warning: #ffa502;
            --success: #2ed573;
            
            /* FONT CUSTOMIZATION VARIABLES */
            --title-font: 'Roboto+Condensed', sans-serif; /* Default title font */
            --title-weight: 800; /* Font weight */
            --title-transform: none; /* text-transform */
            --title-letter-spacing: normal; /* letter-spacing */
        }

        body {
            background: linear-gradient(135deg, var(--darker), #1a1a2e);
            color: var(--light);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .player-container {
            width: 100%;
            max-width: 900px;
            background: rgba(18, 18, 18, 0.85);
            border-radius: 24px;
            overflow: hidden;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.05);
            transition: all 0.3s ease;
        }

        /* Mini Player Styles */
        .player-container.mini-mode {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 300px;
            max-width: 300px;
            z-index: 1000;
            animation: slideInUp 0.3s ease;
        }

        @keyframes slideInUp {
            from {
                transform: translateY(100px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .mini-player-controls {
            display: none;
            position: absolute;
            top: 10px;
            right: 10px;
            gap: 5px;
            z-index: 1001;
        }

        .player-container.mini-mode .mini-player-controls {
            display: flex;
        }

        .mini-control-btn {
            background: rgba(0, 0, 0, 0.7);
            border: none;
            color: white;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
        }

        .mini-control-btn:hover {
            background: rgba(0, 0, 0, 0.9);
            transform: scale(1.1);
        }

        .player-container.mini-mode .player-header,
        .player-container.mini-mode .playlist,
        .player-container.mini-mode .file-upload,
        .player-container.mini-mode .player-footer {
            display: none;
        }

        .player-container.mini-mode .player-body {
            flex-direction: row;
            padding: 10px;
            align-items: center;
        }

        .player-container.mini-mode .now-playing {
            flex-direction: row;
            padding: 0;
            width: 100%;
            gap: 15px;
            align-items: center;
        }

        .player-container.mini-mode .album-art-container {
            width: 50px;
            height: 50px;
            margin-bottom: 0;
            flex-shrink: 0;
        }

        .player-container.mini-mode .album-art i {
            font-size: 20px;
        }

        .player-container.mini-mode .song-info {
            flex: 1;
            margin-bottom: 0;
            text-align: left;
            min-width: 0;
        }

        .player-container.mini-mode .song-title {
            font-size: 14px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .player-container.mini-mode .song-artist {
            font-size: 12px;
        }

        .player-container.mini-mode .progress-container {
            display: none;
        }

        .player-container.mini-mode .controls {
            margin: 0;
            gap: 8px;
        }

        .player-container.mini-mode .control-btn {
            width: 35px;
            height: 35px;
            font-size: 14px;
        }

        .player-container.mini-mode .play-btn {
            width: 40px;
            height: 40px;
            font-size: 16px;
        }

        .player-container.mini-mode .volume-control {
            display: none;
        }

        .mini-toggle {
            position: absolute;
            top: 15px;
            right: 15px;
            background: rgba(255, 255, 255, 0.1);
            border: none;
            color: var(--gray);
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 14px;
        }

        .mini-toggle:hover {
            background: rgba(255, 255, 255, 0.2);
            color: var(--light);
        }

        .player-header {
            padding: 20px 25px;
            text-align: center;
            background: rgba(0, 0, 0, 0.3);
            position: relative;
            overflow: hidden;
        }

        .player-header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(to right, var(--primary), var(--secondary));
        }

        /* TITLE FONT CUSTOMIZATION */
        .player-header h1 {
            font-size: 28px;
            margin-bottom: 6px;
            background: linear-gradient(to right, var(--primary), var(--secondary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            font-weight: var(--title-weight, 700);
            font-family: var(--title-font, 'Poppins', sans-serif);
            text-transform: var(--title-transform, none);
            letter-spacing: var(--title-letter-spacing, normal);
        }

        .player-header p {
            color: var(--gray);
            font-size: 14px;
            letter-spacing: 1px;
        }

        .player-body {
            display: flex;
            flex-direction: column;
            padding: 15px;
            gap: 15px;
        }

        @media (min-width: 768px) {
            .player-body {
                flex-direction: row;
                gap: 20px;
            }
        }

        .now-playing {
            flex: 1;
            min-width: 280px;
            max-width: 400px;
            padding: 15px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .album-art-container {
            position: relative;
            width: 160px;
            height: 160px;
            margin-bottom: 20px;
        }

        .album-art {
            width: 100%;
            height: 100%;
            border-radius: 16px;
            background: linear-gradient(45deg, var(--primary), var(--secondary));
            display: flex;
            justify-content: center;
            align-items: center;
            box-shadow: 0 10px 25px rgba(46, 151, 242, 0.3);
            overflow: hidden;
            position: relative;
        }

        .album-art::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, rgba(46, 151, 242, 0.2), rgba(255, 0, 0, 0.2));
        }

        .album-art i {
            font-size: 50px;
            color: rgba(255, 255, 255, 0.8);
            z-index: 1;
        }

        .song-info {
            text-align: center;
            margin-bottom: 18px;
            width: 100%;
            min-width: 0;
        }

        .song-title {
            font-size: 22px;
            font-weight: bold;
            margin-bottom: 6px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 100%;
            padding: 0 10px;
        }

        .song-artist {
            font-size: 16px;
            color: var(--gray);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 100%;
            padding: 0 10px;
        }

        .progress-container {
            width: 100%;
            margin: 18px 0;
        }

        .progress-bar {
            width: 100%;
            height: 6px;
            background: rgba(255, 255,255, 0.1);
            border-radius: 3px;
            cursor: pointer;
            position: relative;
            overflow: hidden;
        }

        .progress {
            height: 100%;
            background: linear-gradient(to right, var(--primary), var(--secondary));
            border-radius: 3px;
            width: 0%;
            transition: width 0.1s linear;
            position: relative;
        }

        .progress::after {
            content: '';
            position: absolute;
            top: 0;
            right: 0;
            width: 12px;
            height: 12px;
            background: white;
            border-radius: 50%;
            transform: translate(50%, -25%);
            box-shadow: 0 0 10px rgba(255, 255, 255, 0.8);
        }

        .time-display {
            display: flex;
            justify-content: space-between;
            margin-top: 8px;
            font-size: 13px;
            color: var(--gray);
        }

        .controls {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 15px;
            margin: 18px 0;
        }

        .control-btn {
            background: rgba(255, 255, 255, 0.1);
            border: none;
            color: white;
            font-size: 18px;
            cursor: pointer;
            transition: all 0.3s ease;
            width: 45px;
            height: 45px;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            backdrop-filter: blur(5px);
        }

        .control-btn:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: scale(1.05);
        }

        .play-btn {
            background: linear-gradient(45deg, var(--primary), var(--secondary));
            width: 65px;
            height: 65px;
            font-size: 26px;
            box-shadow: 0 5px 15px rgba(46, 151, 242, 0.4);
        }

        .play-btn:hover {
            transform: scale(1.08);
            box-shadow: 0 8px 20px rgba(46, 151, 242, 0.6);
        }

        .volume-control {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 12px;
            width: 100%;
        }

        .volume-slider {
            flex: 1;
            height: 5px;
            -webkit-appearance: none;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 3px;
            outline: none;
        }

        .volume-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: var(--primary);
            cursor: pointer;
            box-shadow: 0 0 10px rgba(46, 151, 242, 0.8);
        }

        .playlist {
            flex: 1.2;
            min-width: 300px;
            max-width: 500px;
            padding: 18px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 16px;
            max-height: 420px;
            overflow-y: auto;
            overflow-x: hidden;
            position: relative;
        }

        .playlist-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 18px;
            gap: 10px;
            flex-wrap: wrap;
        }

        .playlist h2 {
            font-size: 20px;
            color: var(--primary);
            display: flex;
            align-items: center;
            gap: 8px;
            white-space: nowrap;
        }

        .playlist h2 i {
            font-size: 18px;
        }

        .playlist-actions {
            display: flex;
            gap: 5px;
            flex-wrap: wrap;
            justify-content: flex-end;
            flex: 1;
            min-width: 0;
        }

        .action-btn {
            background: rgba(255, 255, 255, 0.1);
            border: none;
            color: white;
            padding: 7px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 4px;
            white-space: nowrap;
            flex-shrink: 0;
            width: 34px;
            height: 34px;
        }

        .btn-text {
            display: none !important;
        }

        .action-btn:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .clear-btn {
            background: rgba(255, 71, 87, 0.2);
            color: var(--danger);
        }

        .clear-btn:hover {
            background: rgba(255, 71, 87, 0.3);
        }

        .offline-btn {
            background: rgba(46, 151, 242, 0.2);
            color: var(--primary);
        }

        .offline-btn:hover {
            background: rgba(46, 151, 242, 0.3);
        }

        .offline-btn.active {
            background: rgba(46, 151, 242, 0.4);
            color: var(--light);
        }

        .mini-btn {
            background: rgba(255, 255, 255, 0.1);
            color: white;
        }

        .mini-btn:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .mini-btn.active {
            background: rgba(46, 151, 242, 0.4);
            color: var(--light);
        }

        .sort-btn {
            background: rgba(255, 255, 255, 0.1);
            color: white;
            position: relative;
        }

        .sort-btn:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .sort-dropdown {
            position: absolute;
            top: 100%;
            right: 0;
            background: var(--dark);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            padding: 8px;
            min-width: 150px;
            z-index: 100;
            display: none;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3);
        }

        .sort-dropdown.show {
            display: block;
        }

        .sort-option {
            background: none;
            border: none;
            color: var(--gray);
            padding: 8px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            width: 100%;
            text-align: left;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.2s ease;
        }

        .sort-option:hover {
            background: rgba(255, 255, 255, 0.1);
            color: var(--light);
        }

        .sort-option.active {
            color: var(--primary);
            background: rgba(46, 151, 242, 0.1);
        }

        .playlist-item {
            display: flex;
            align-items: center;
            padding: 10px 12px;
            border-radius: 10px;
            margin-bottom: 6px;
            cursor: grab;
            transition: all 0.2s ease;
            border-left: 3px solid transparent;
            position: relative;
            user-select: none;
        }

        .playlist-item:active {
            cursor: grabbing;
        }

        .playlist-item.dragging {
            opacity: 0.5;
            transform: scale(0.98);
        }

        .playlist-item:hover {
            background: rgba(255, 255, 255, 0.05);
            transform: translateX(5px);
        }

        .playlist-item:hover .remove-btn {
            opacity: 1;
        }

        .playlist-item.active {
            background: rgba(46, 151, 242, 0.15);
            border-left: 3px solid var(--primary);
        }

        .playlist-item.offline {
            border-left: 3px solid var(--success);
        }

        .playlist-item.imported {
            border-left: 3px solid var(--warning);
        }

        .playlist-info {
            flex: 1;
            min-width: 0;
        }

        .playlist-title {
            font-weight: bold;
            margin-bottom: 3px;
            font-size: 14px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .playlist-artist {
            font-size: 12px;
            color: var(--gray);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .playlist-duration {
            font-size: 12px;
            color: var(--gray);
            margin-right: 8px;
            flex-shrink: 0;
        }

        .format-badge {
            background: rgba(46, 151, 242, 0.3);
            color: var(--primary);
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 9px;
            font-weight: bold;
            margin-left: 6px;
        }

        .offline-badge {
            background: rgba(46, 214, 115, 0.3);
            color: var(--success);
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 9px;
            font-weight: bold;
            margin-left: 6px;
        }

        .missing-audio-badge {
            background: rgba(255, 71, 87, 0.3);
            color: var(--danger);
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 9px;
            font-weight: bold;
            margin-left: 6px;
        }

        .drag-handle {
            color: var(--gray);
            margin-right: 8px;
            cursor: grab;
            font-size: 12px;
            flex-shrink: 0;
        }

        .drag-handle:active {
            cursor: grabbing;
        }

        .remove-btn {
            background: rgba(255, 71, 87, 0.2);
            border: none;
            color: var(--danger);
            width: 26px;
            height: 26px;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            transition: all 0.3s ease;
            opacity: 0;
            font-size: 11px;
            flex-shrink: 0;
        }

        .remove-btn:hover {
            background: rgba(255, 71, 87, 0.8);
            color: white;
            transform: scale(1.1);
        }

        .playlist::-webkit-scrollbar {
            width: 6px;
        }

        .playlist::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 3px;
        }

        .playlist::-webkit-scrollbar-thumb {
            background: var(--primary);
            border-radius: 3px;
        }

        .playlist::-webkit-scrollbar-thumb:hover {
            background: var(--secondary);
        }

        .file-upload {
            text-align: center;
            margin-top: 18px;
            padding: 12px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .upload-btn {
            background: linear-gradient(45deg, var(--primary), var(--secondary));
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 50px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            box-shadow: 0 5px 15px rgba(46, 151, 242, 0.4);
            font-size: 14px;
        }

        .upload-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(46, 151, 242, 0.6);
        }

        #file-input {
            display: none;
        }

        .player-footer {
            padding: 12px;
            text-align: center;
            color: var(--gray);
            font-size: 13px;
            border-top: 1px solid rgba(255, 255, 255, 0.05);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 10px;
        }

        .footer-info {
            display: flex;
            gap: 15px;
        }

        .info-btn {
            background: none;
            border: none;
            color: var(--gray);
            font-size: 12px;
            cursor: pointer;
            transition: color 0.3s ease;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .info-btn:hover {
            color: var(--primary);
        }

        .empty-playlist {
            text-align: center;
            padding: 30px 15px;
            color: var(--gray);
        }

        .empty-playlist i {
            font-size: 40px;
            margin-bottom: 12px;
            opacity: 0.5;
        }

        .empty-playlist p {
            font-size: 14px;
            margin-bottom: 5px;
        }

        .supported-formats {
            margin-top: 8px;
            font-size: 11px;
            color: var(--gray);
            text-align: center;
            width: 100%;
        }

        .supported-formats span {
            color: var(--primary);
            font-weight: bold;
        }

        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 12px 18px;
            border-radius: 8px;
            color: white;
            font-weight: 500;
            z-index: 1000;
            transform: translateX(400px);
            transition: transform 0.3s ease;
            max-width: 300px;
            font-size: 14px;
        }

        .toast.show {
            transform: translateX(0);
        }

        .toast.error {
            background: var(--danger);
        }

        .toast.warning {
            background: var(--warning);
            color: #333;
        }

        .toast.success {
            background: var(--success);
        }

        .toast.info {
            background: var(--primary);
        }

        /* Upload Progress Modal */
        .upload-progress-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.85);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 2000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }

        .upload-progress-modal.active {
            opacity: 1;
            visibility: visible;
        }

        .upload-progress-content {
            background: var(--dark);
            border-radius: 16px;
            padding: 30px;
            max-width: 400px;
            width: 90%;
            text-align: center;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.5);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .upload-progress-header {
            margin-bottom: 20px;
        }

        .upload-progress-header h3 {
            color: var(--primary);
            font-size: 22px;
            margin-bottom: 8px;
        }

        .upload-progress-header p {
            color: var(--gray);
            font-size: 14px;
        }

        .upload-progress-bar {
            width: 100%;
            height: 8px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 4px;
            overflow: hidden;
            margin: 20px 0;
        }

        .upload-progress-fill {
            height: 100%;
            background: linear-gradient(to right, var(--primary), var(--secondary));
            border-radius: 4px;
            width: 0%;
            transition: width 0.3s ease;
        }

        .upload-progress-stats {
            display: flex;
            justify-content: space-between;
            margin-top: 10px;
            font-size: 14px;
            color: var(--gray);
        }

        .upload-progress-stats span {
            color: var(--light);
            font-weight: bold;
        }

        /* Skeleton Loading */
        .skeleton-track {
            display: flex;
            align-items: center;
            padding: 10px 12px;
            margin-bottom: 6px;
            animation: pulse 1.5s infinite;
        }

        .skeleton-drag {
            width: 12px;
            height: 20px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 3px;
            margin-right: 8px;
        }

        .skeleton-info {
            flex: 1;
        }

        .skeleton-title {
            width: 70%;
            height: 16px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 3px;
            margin-bottom: 6px;
        }

        .skeleton-artist {
            width: 50%;
            height: 12px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 3px;
        }

        .skeleton-duration {
            width: 40px;
            height: 12px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 3px;
            margin-right: 8px;
        }

        @keyframes pulse {
            0%, 100% {
                opacity: 0.6;
            }
            50% {
                opacity: 0.8;
            }
        }

        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }

        .modal-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .modal {
            background: var(--dark);
            border-radius: 16px;
            padding: 24px;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow: hidden;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.5);
            border: 1px solid rgba(255, 255, 255, 0.1);
            transform: scale(0.9);
            transition: transform 0.3s ease;
            display: flex;
            flex-direction: column;
        }

        .modal-overlay.active .modal {
            transform: scale(1);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-shrink: 0;
        }

        .modal-header h3 {
            color: var(--primary);
            font-size: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .close-modal {
            background: none;
            border: none;
            color: var(--gray);
            font-size: 20px;
            cursor: pointer;
            transition: color 0.3s ease;
        }

        .close-modal:hover {
            color: var(--light);
        }

        .modal-content {
            line-height: 1.6;
            color: var(--gray);
            overflow-y: auto;
            overflow-x: hidden;
            padding-right: 5px;
            flex: 1;
        }

        .modal-content::-webkit-scrollbar {
            width: 6px;
        }

        .modal-content::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 3px;
        }

        .modal-content::-webkit-scrollbar-thumb {
            background: var(--primary);
            border-radius: 3px;
        }

        .modal-content::-webkit-scrollbar-thumb:hover {
            background: var(--secondary);
        }

        .modal-content p {
            margin-bottom: 15px;
        }

        .modal-content ul {
            margin-left: 20px;
            margin-bottom: 15px;
        }

        .modal-content li {
            margin-bottom: 8px;
        }

        .feature-list {
            background: rgba(255, 255, 255, 0.05);
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
        }

        .progress-indicator {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-top: 10px;
            font-size: 12px;
            color: var(--gray);
        }

        .progress-bar-small {
            flex: 1;
            height: 4px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 2px;
            overflow: hidden;
        }

        .progress-small {
            height: 100%;
            background: var(--primary);
            width: 0%;
            transition: width 0.3s ease;
        }

        .export-import-btns {
            display: flex;
            gap: 5px;
        }
        
        .export-btn, .import-btn {
            background: rgba(46, 151, 242, 0.2);
            color: var(--primary);
        }
        
        .export-btn:hover, .import-btn:hover {
            background: rgba(46, 151, 242, 0.3);
        }
        
        #import-input {
            display: none;
        }
        
        .feature-highlight {
            background: rgba(46, 151, 242, 0.1);
            border-left: 3px solid var(--primary);
            padding: 10px 15px;
            margin: 15px 0;
            border-radius: 0 8px 8px 0;
        }

        .tooltip {
            position: relative;
        }

        .tooltip::after {
            content: attr(title);
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 5px 10px;
            border-radius: 4px;
            font-size: 12px;
            white-space: nowrap;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
            z-index: 1000;
        }

        .tooltip:hover::after {
            opacity: 1;
        }

        /* Footer copyright text - fixed to match About button size */
        .player-footer p {
            font-size: 12px;
            color: var(--gray);
        }
    </style>
</head>
<body>
    <div class="toast" id="toast"></div>
    
    <!-- Upload Progress Modal -->
    <div class="upload-progress-modal" id="upload-progress-modal">
        <div class="upload-progress-content">
            <div class="upload-progress-header">
                <h3><i class="fas fa-music"></i> Adding Tracks</h3>
                <p>Processing your audio files...</p>
            </div>
            <div class="upload-progress-bar">
                <div class="upload-progress-fill" id="upload-progress-fill"></div>
            </div>
            <div class="upload-progress-stats">
                <div>Processed: <span id="processed-count">0</span> / <span id="total-count">0</span></div>
                <div id="upload-speed">Starting...</div>
            </div>
        </div>
    </div>
    
    <div class="modal-overlay" id="export-modal">
        <div class="modal">
            <div class="modal-header">
                <h3><i class="fas fa-folder-open"></i> Select Music Folder</h3>
                <button class="close-modal" id="close-export">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-content">
                <p>For folder-based playlist export, please select your main music folder. This will be used as the reference point for all audio files.</p>
                <p><strong>How it works:</strong></p>
                <ul>
                    <li>All audio file paths will be saved relative to this folder</li>
                    <li>When importing, select the same folder to restore files</li>
                    <li>Keep your music organized in this folder structure</li>
                </ul>
                <div class="feature-highlight">
                    <p><strong>Tip:</strong> This creates small playlist files that reference your existing audio files. No audio data is duplicated.</p>
                </div>
                <button id="select-folder-btn" class="upload-btn" style="margin: 20px auto; display: block;">
                    <i class="fas fa-folder-open"></i> Select Music Folder
                </button>
                <div id="selected-folder-info" style="text-align: center; margin-top: 15px; display: none;">
                    <p><i class="fas fa-check-circle" style="color: var(--success);"></i> Folder selected: <span id="folder-path"></span></p>
                </div>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="import-modal">
        <div class="modal">
            <div class="modal-header">
                <h3><i class="fas fa-folder-open"></i> Locate Music Folder</h3>
                <button class="close-modal" id="close-import">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-content">
                <p>To restore this playlist, please select the music folder where your audio files are located.</p>
                <p><strong>Important:</strong> This should be the same folder you used when exporting the playlist, or the folder containing your music files.</p>
                <div id="import-stats" style="margin: 15px 0; padding: 10px; background: rgba(255,255,255,0.05); border-radius: 8px;">
                    <p>Playlist contains: <span id="track-count">0</span> tracks</p>
                    <p>Missing files: <span id="missing-count">0</span></p>
                </div>
                <button id="select-import-folder-btn" class="upload-btn" style="margin: 20px auto; display: block;">
                    <i class="fas fa-folder-open"></i> Select Music Folder
                </button>
                <div id="import-progress" style="display: none;">
                    <div class="progress-indicator">
                        <span>Restoring tracks...</span>
                        <div class="progress-bar-small">
                            <div class="progress-small" id="import-progress-bar"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="modal-overlay" id="about-modal">
        <div class="modal">
            <div class="modal-header">
                <h3><i class="fas fa-info-circle"></i> About MiaPlay</h3>
                <button class="close-modal" id="close-about">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-content">
                <p><strong>MiaPlay</strong> is a modern, browser-based music player designed for simplicity and elegance. Enjoy your music collection with an intuitive interface that puts the focus on what matters most - your music.</p>
                
                <div class="feature-list">
                    <p><strong>Key Features:</strong></p>
                    <ul>
                        <li>Multi-format audio support (MP3, WAV, OGG, M4A, WebM, FLAC)</li>
                        <li>Drag & drop playlist management</li>
                        <li>Offline playback support</li>
                        <li>Mini Player mode</li>
                        <li>Playlist sorting (title, artist, duration, date added)</li>
                        <li><strong>Playlist Export/Import</strong> - Save and load your playlists</li>
                        <li>Clean, responsive design</li>
                        <li>No installation required</li>
                    </ul>
                </div>
                
                <div class="feature-highlight">
                    <p><strong>New: Smart Playlist Export</strong></p>
                    <p>Export playlists as small reference files that point to your existing audio files. No audio duplication, saves storage space!</p>
                    <p><strong>How it works:</strong> Select a music folder when exporting. MiaPlay saves relative paths to your audio files. When importing, select the same folder to restore your playlist.</p>
                </div>
                
                <p>MiaPlay works entirely in your browser - your files never leave your device. Simply add your audio files and start listening!</p>
            </div>
        </div>
    </div>
    
    <div class="player-container" id="player-container">
        <button class="mini-toggle" id="mini-toggle" title="Toggle Mini Player">
            <i class="fas fa-compress"></i>
        </button>
        
        <div class="mini-player-controls">
            <button class="mini-control-btn" id="mini-close" title="Close Mini Player">
                <i class="fas fa-times"></i>
            </button>
        </div>
        
        <div class="player-header">
            <h1>MiaPlay</h1>
            <p>Sound | Listen | Play</p>
        </div>
        
        <div class="player-body">
            <div class="now-playing">
                <div class="album-art-container" id="album-art-container">
                    <div class="album-art">
                        <i class="fas fa-music"></i>
                    </div>
                </div>
                
                <div class="song-info">
                    <div class="song-title" id="song-title">Select a song</div>
                    <div class="song-artist" id="song-artist">Artist name</div>
                </div>
                
                <div class="progress-container">
                    <div class="progress-bar" id="progress-bar">
                        <div class="progress" id="progress"></div>
                    </div>
                    <div class="time-display">
                        <span id="current-time">0:00</span>
                        <span id="duration">0:00</span>
                    </div>
                </div>
                
                <div class="controls">
                    <button class="control-btn" id="shuffle-btn" title="Shuffle">
                        <i class="fas fa-random"></i>
                    </button>
                    <button class="control-btn" id="prev-btn" title="Previous">
                        <i class="fas fa-step-backward"></i>
                    </button>
                    <button class="control-btn play-btn" id="play-btn" title="Play">
                        <i class="fas fa-play"></i>
                    </button>
                    <button class="control-btn" id="next-btn" title="Next">
                        <i class="fas fa-step-forward"></i>
                    </button>
                    <button class="control-btn" id="repeat-btn" title="Repeat">
                        <i class="fas fa-redo"></i>
                    </button>
                </div>
                
                <div class="volume-control">
                    <i class="fas fa-volume-down"></i>
                    <!-- VOLUME FIX: Changed from value="50" to value="25" -->
                    <input type="range" class="volume-slider" id="volume-slider" min="0" max="100" value="25">
                    <i class="fas fa-volume-up"></i>
                </div>
                
                <div class="file-upload">
                    <button class="upload-btn" id="upload-btn">
                        <i class="fas fa-plus"></i> Add Audio Files
                    </button>
                    <input type="file" id="file-input" accept="audio/mp3, audio/mpeg, audio/wav, audio/ogg, audio/webm, audio/flac, audio/aac, audio/m4a, audio/x-m4a" multiple>
                    <div class="supported-formats">
                        Supported: <span>MP3, WAV, OGG, M4A, WebM, FLAC</span>
                    </div>
                </div>
            </div>
            
            <div class="playlist">
                <div class="playlist-header">
                    <h2><i class="fas fa-list"></i> Playlist</h2>
                    <div class="playlist-actions">
                        <div class="export-import-btns">
                            <button class="action-btn export-btn tooltip" id="export-btn" title="Export Playlist">
                                <i class="fas fa-share"></i>
                                <span class="btn-text">Export</span>
                            </button>
                            <button class="action-btn import-btn tooltip" id="import-btn" title="Import Playlist">
                                <i class="fas fa-file-import"></i>
                                <span class="btn-text">Import</span>
                            </button>
                            <input type="file" id="import-input" accept=".json,.miaplay,application/json">
                        </div>
                        <div class="sort-container" style="position: relative;">
                            <button class="action-btn sort-btn tooltip" id="sort-btn" title="Sort Playlist">
                                <i class="fas fa-sort"></i>
                                <span class="btn-text">Sort</span>
                            </button>
                            <div class="sort-dropdown" id="sort-dropdown">
                                <button class="sort-option" data-sort="title">
                                    <i class="fas fa-font"></i> Title
                                </button>
                                <button class="sort-option" data-sort="artist">
                                    <i class="fas fa-user"></i> Artist
                                </button>
                                <button class="sort-option" data-sort="duration">
                                    <i class="fas fa-clock"></i> Duration
                                </button>
                                <button class="sort-option" data-sort="date">
                                    <i class="fas fa-calendar"></i> Date Added
                                </button>
                            </div>
                        </div>
                        <button class="action-btn mini-btn tooltip" id="mini-mode-btn" title="Mini Player Mode">
                            <i class="fas fa-compress"></i>
                            <span class="btn-text">Mini</span>
                        </button>
                        <button class="action-btn offline-btn tooltip" id="offline-btn" title="Enable offline mode">
                            <i class="fas fa-download"></i>
                            <span class="btn-text">Offline</span>
                        </button>
                        <button class="action-btn clear-btn tooltip" id="clear-btn" title="Clear playlist">
                            <i class="fas fa-trash"></i>
                            <span class="btn-text">Clear All</span>
                        </button>
                    </div>
                </div>
                <div id="playlist-items">
                    <div class="empty-playlist">
                        <i class="fas fa-music"></i>
                        <p>Your playlist is empty</p>
                        <p>Add some songs to get started</p>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="player-footer">
            <div class="footer-info">
                <button class="info-btn" id="about-btn">
                    <i class="fas fa-info-circle"></i> About MiaPlay
                </button>
            </div>
            <p>MiaPlay Â© 2025</p>
            <div class="progress-indicator" id="offline-progress" style="display: none;">
                <span>Caching...</span>
                <div class="progress-bar-small">
                    <div class="progress-small" id="offline-progress-bar"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Core audio player
            const audioPlayer = new Audio();
            
            // DOM Elements
            const playerContainer = document.getElementById('player-container');
            const playBtn = document.getElementById('play-btn');
            const prevBtn = document.getElementById('prev-btn');
            const nextBtn = document.getElementById('next-btn');
            const shuffleBtn = document.getElementById('shuffle-btn');
            const repeatBtn = document.getElementById('repeat-btn');
            const progressBar = document.getElementById('progress-bar');
            const progress = document.getElementById('progress');
            const currentTimeEl = document.getElementById('current-time');
            const durationEl = document.getElementById('duration');
            
            // VOLUME FIX: Set to 25% by default
            const volumeSlider = document.getElementById('volume-slider');
            volumeSlider.value = 25; // Ensure it's set to 25%
            audioPlayer.volume = 0.25; // Set audio player volume
            
            const playlistItems = document.getElementById('playlist-items');
            const fileInput = document.getElementById('file-input');
            const uploadBtn = document.getElementById('upload-btn');
            const offlineBtn = document.getElementById('offline-btn');
            const miniModeBtn = document.getElementById('mini-mode-btn');
            const miniToggle = document.getElementById('mini-toggle');
            const miniClose = document.getElementById('mini-close');
            const sortBtn = document.getElementById('sort-btn');
            const sortDropdown = document.getElementById('sort-dropdown');
            const sortOptions = document.querySelectorAll('.sort-option');
            const clearBtn = document.getElementById('clear-btn');
            const aboutBtn = document.getElementById('about-btn');
            const songTitle = document.getElementById('song-title');
            const songArtist = document.getElementById('song-artist');
            const albumArtContainer = document.getElementById('album-art-container');
            const toast = document.getElementById('toast');
            const offlineProgress = document.getElementById('offline-progress');
            const offlineProgressBar = document.getElementById('offline-progress-bar');
            const exportBtn = document.getElementById('export-btn');
            const importBtn = document.getElementById('import-btn');
            const importInput = document.getElementById('import-input');
            const aboutModal = document.getElementById('about-modal');
            const exportModal = document.getElementById('export-modal');
            const importModal = document.getElementById('import-modal');
            const closeAboutModal = document.getElementById('close-about');
            const closeExportModal = document.getElementById('close-export');
            const closeImportModal = document.getElementById('close-import');
            const selectFolderBtn = document.getElementById('select-folder-btn');
            const selectImportFolderBtn = document.getElementById('select-import-folder-btn');
            const selectedFolderInfo = document.getElementById('selected-folder-info');
            const folderPath = document.getElementById('folder-path');
            const importStats = document.getElementById('import-stats');
            const trackCount = document.getElementById('track-count');
            const missingCount = document.getElementById('missing-count');
            const importProgress = document.getElementById('import-progress');
            const importProgressBar = document.getElementById('import-progress-bar');
            
            // Upload progress modal elements
            const uploadProgressModal = document.getElementById('upload-progress-modal');
            const uploadProgressFill = document.getElementById('upload-progress-fill');
            const processedCount = document.getElementById('processed-count');
            const totalCount = document.getElementById('total-count');
            const uploadSpeed = document.getElementById('upload-speed');
            
            // Constants
            const SUPPORTED_FORMATS = {
                'mp3': 'MP3', 'mpeg': 'MP3', 'wav': 'WAV', 'ogg': 'OGG', 
                'webm': 'WebM', 'flac': 'FLAC', 'aac': 'AAC', 'm4a': 'M4A', 'x-m4a': 'M4A'
            };
            
            // State variables
            let isPlaying = false;
            let currentTrackIndex = 0;
            let isShuffled = false;
            let isRepeating = false;
            let isOfflineMode = false;
            let isMiniMode = false;
            let currentSort = 'date';
            let tracks = [];
            let dragSrcElement = null;
            
            // Performance optimization
            let trackFiles = new Map(); // Maps track ID -> File object
            let activeBlobUrl = null;   // Currently active Blob URL
            
            // File paths for folder-based export
            let filePaths = new Map(); // Maps track ID -> relative path
            let currentExportFolder = null;
            let currentImportData = null;
            
            // Track identity
            let trackIdCounter = 0;
            
            // Browser capability check
            const supportsOffline = 'serviceWorker' in navigator && 'caches' in window;
            
            // Upload state
            let uploadStartTime = null;
            let lastUpdateTime = null;
            
            // ========== HELPER FUNCTIONS ==========
            
            function showToast(message, type = 'error', duration = 4000) {
                toast.textContent = message;
                toast.className = `toast ${type} show`;
                setTimeout(() => {
                    toast.classList.remove('show');
                }, duration);
            }
            
            function formatTime(seconds) {
                if (isNaN(seconds)) return "0:00";
                const hours = Math.floor(seconds / 3600);
                const minutes = Math.floor((seconds % 3600) / 60);
                const secs = Math.floor(seconds % 60);
                if (hours > 0) {
                    return `${hours}:${minutes < 10 ? '0' : ''}${minutes}:${secs < 10 ? '0' : ''}${secs}`;
                } else {
                    return `${minutes}:${secs < 10 ? '0' : ''}${secs}`;
                }
            }
            
            function timeToSeconds(timeStr) {
                if (!timeStr || timeStr === '--:--' || timeStr === 'Loading...') return 0;
                
                const parts = timeStr.split(':').map(Number);
                if (parts.length === 3) {
                    return parts[0] * 3600 + parts[1] * 60 + parts[2];
                } else if (parts.length === 2) {
                    return parts[0] * 60 + parts[1];
                }
                return 0;
            }
            
            function extractMetadataFromFilename(filename) {
                const nameWithoutExt = filename.replace(/\.[^/.]+$/, "");
                
                let title = nameWithoutExt;
                let artist = "Unknown Artist";
                
                // Pattern: Artist - Title
                const artistTitleMatch = nameWithoutExt.match(/^(.+?)\s*[-ââ]\s*(.+)$/);
                if (artistTitleMatch) {
                    artist = artistTitleMatch[1].trim();
                    title = artistTitleMatch[2].trim();
                    
                    artist = artist.replace(/^\d+\.\s*/, '');
                    title = title.replace(/^\d+\.\s*/, '');
                }
                
                if (artist === "Unknown Artist") {
                    const titleArtistMatch = nameWithoutExt.match(/^(.+?)\s*[-ââ]\s*(.+)$/);
                    if (titleArtistMatch) {
                        title = titleArtistMatch[1].trim();
                        artist = titleArtistMatch[2].trim();
                    }
                }
                
                title = title.replace(/_/g, ' ');
                artist = artist.replace(/_/g, ' ');
                
                return { title, artist };
            }
            
            async function getTrackDuration(file) {
                return new Promise((resolve) => {
                    const tempAudio = new Audio();
                    const objectUrl = URL.createObjectURL(file);
                    
                    tempAudio.src = objectUrl;
                    tempAudio.addEventListener('loadedmetadata', () => {
                        resolve(tempAudio.duration);
                        URL.revokeObjectURL(objectUrl);
                    });
                    
                    tempAudio.addEventListener('error', () => {
                        resolve(0);
                        URL.revokeObjectURL(objectUrl);
                    });
                    
                    setTimeout(() => {
                        resolve(0);
                        URL.revokeObjectURL(objectUrl);
                    }, 5000);
                });
            }
            
            // ========== MODERN PROGRESSIVE UPLOAD ==========
            
            function showSkeletonTracks(count) {
                const skeletonHTML = Array.from({length: Math.min(count, 10)}, () => `
                    <div class="skeleton-track">
                        <div class="skeleton-drag"></div>
                        <div class="skeleton-info">
                            <div class="skeleton-title"></div>
                            <div class="skeleton-artist"></div>
                        </div>
                        <div class="skeleton-duration"></div>
                    </div>
                `).join('');
                
                playlistItems.innerHTML = skeletonHTML;
            }
            
            function showUploadProgress(processed, total) {
                processedCount.textContent = processed;
                totalCount.textContent = total;
                
                const progressPercent = (processed / total) * 100;
                uploadProgressFill.style.width = `${progressPercent}%`;
                
                // Calculate speed
                if (uploadStartTime) {
                    const currentTime = Date.now();
                    const elapsedSeconds = (currentTime - uploadStartTime) / 1000;
                    const filesPerSecond = processed / elapsedSeconds;
                    
                    if (filesPerSecond > 1) {
                        uploadSpeed.textContent = `${filesPerSecond.toFixed(1)} files/sec`;
                    } else {
                        const secondsPerFile = elapsedSeconds / processed;
                        uploadSpeed.textContent = `${secondsPerFile.toFixed(1)} sec/file`;
                    }
                    
                    lastUpdateTime = currentTime;
                }
            }
            
            async function processSingleFile(file) {
                try {
                    const format = getFileFormat(file);
                    if (!format || format === 'Unknown') return null;
                    
                    const metadata = extractMetadataFromFilename(file.name);
                    const duration = await getTrackDuration(file);
                    
                    const trackId = trackIdCounter++;
                    const track = {
                        id: trackId,
                        title: metadata.title,
                        artist: metadata.artist,
                        duration: formatTime(duration),
                        format: format,
                        offline: false,
                        dateAdded: Date.now(),
                        originalFilename: file.name,
                        fileSize: file.size
                    };
                    
                    trackFiles.set(trackId, file);
                    
                    if (file.webkitRelativePath) {
                        filePaths.set(trackId, file.webkitRelativePath);
                    }
                    
                    return track;
                } catch (error) {
                    console.error('Error processing file:', file.name, error);
                    return null;
                }
            }
            
            async function handleModernFileUpload(files) {
                const validFiles = Array.from(files).filter(file => {
                    const format = getFileFormat(file);
                    return format && format !== 'Unknown' && file.size <= 100 * 1024 * 1024;
                });
                
                if (validFiles.length === 0) {
                    showToast('No valid audio files selected', 'warning');
                    return;
                }
                
                // 1. INSTANT FEEDBACK: Show progress modal
                uploadStartTime = Date.now();
                uploadProgressModal.classList.add('active');
                totalCount.textContent = validFiles.length;
                processedCount.textContent = 0;
                uploadSpeed.textContent = 'Starting...';
                
                // 2. SHOW SKELETON LOADING
                showSkeletonTracks(validFiles.length);
                
                let allTracks = [];
                let processedFiles = 0;
                
                // 3. PRIORITY PROCESSING: First 5 files immediately
                const priorityBatch = validFiles.slice(0, 5);
                const priorityPromises = priorityBatch.map(async (file, index) => {
                    const track = await processSingleFile(file);
                    processedFiles++;
                    showUploadProgress(processedFiles, validFiles.length);
                    return track;
                });
                
                const priorityTracks = (await Promise.all(priorityPromises)).filter(Boolean);
                allTracks.push(...priorityTracks);
                
                // 4. UPDATE UI with first batch
                tracks.push(...priorityTracks);
                renderPlaylist();
                
                // 5. BACKGROUND PROCESSING: Remaining files
                if (validFiles.length > 5) {
                    const remainingFiles = validFiles.slice(5);
                    
                    // Process in adaptive batches
                    const batchSize = Math.min(3, Math.max(1, Math.floor(remainingFiles.length / 10)));
                    
                    for (let i = 0; i < remainingFiles.length; i += batchSize) {
                        const batch = remainingFiles.slice(i, i + batchSize);
                        const batchPromises = batch.map(async (file) => {
                            const track = await processSingleFile(file);
                            processedFiles++;
                            showUploadProgress(processedFiles, validFiles.length);
                            return track;
                        });
                        
                        const batchTracks = (await Promise.all(batchPromises)).filter(Boolean);
                        allTracks.push(...batchTracks);
                        
                        // Add to tracks array but only render occasionally
                        tracks.push(...batchTracks);
                        
                        // Render every 5 files or at the end
                        if (i % 10 === 0 || i + batchSize >= remainingFiles.length) {
                            renderPlaylist();
                        }
                        
                        // Yield to browser to keep UI responsive
                        await new Promise(resolve => setTimeout(resolve, 0));
                    }
                }
                
                // 6. FINALIZE
                setTimeout(() => {
                    uploadProgressModal.classList.remove('active');
                    showToast(`Added ${allTracks.length} track${allTracks.length !== 1 ? 's' : ''} to playlist`, 'success');
                }, 500);
                
                // Final render
                renderPlaylist();
                
                return allTracks.length;
            }
            
            // ========== TITLE FONT CUSTOMIZATION GUIDE ==========
            
            // To change the title font, modify these CSS variables in the :root selector:
            /*
            Example 1: Bold Montserrat
            --title-font: 'Montserrat', sans-serif;
            --title-weight: 800;
            --title-transform: uppercase;
            --title-letter-spacing: 1px;
            
            Example 2: Roboto Condensed
            --title-font: 'Roboto Condensed', sans-serif;
            --title-weight: 700;
            --title-transform: none;
            --title-letter-spacing: 0.5px;
            
            Example 3: Bebas Neue (all caps)
            --title-font: 'Bebas Neue', sans-serif;
            --title-weight: 400;
            --title-transform: uppercase;
            --title-letter-spacing: 2px;
            */
            
            // ========== EVENT LISTENERS ==========
            
            playBtn.addEventListener('click', togglePlay);
            prevBtn.addEventListener('click', playPrevious);
            nextBtn.addEventListener('click', playNext);
            shuffleBtn.addEventListener('click', toggleShuffle);
            repeatBtn.addEventListener('click', toggleRepeat);
            progressBar.addEventListener('click', setProgress);
            
            // VOLUME FIX: Set initial volume and add event listener
            volumeSlider.addEventListener('input', function() {
                const volume = this.value / 100;
                audioPlayer.volume = volume;
            });
            
            uploadBtn.addEventListener('click', () => {
                fileInput.click();
                showToast('Select audio files from your device', 'info');
            });
            
            fileInput.addEventListener('change', async (e) => {
                const files = e.target.files;
                if (files.length > 0) {
                    await handleModernFileUpload(files);
                }
                fileInput.value = '';
            });
            
            clearBtn.addEventListener('click', clearPlaylist);
            offlineBtn.addEventListener('click', toggleOfflineMode);
            miniModeBtn.addEventListener('click', toggleMiniMode);
            miniToggle.addEventListener('click', toggleMiniMode);
            miniClose.addEventListener('click', toggleMiniMode);
            
            sortBtn.addEventListener('click', toggleSortDropdown);
            sortOptions.forEach(option => {
                option.addEventListener('click', () => {
                    const sortType = option.dataset.sort;
                    sortPlaylist(sortType);
                    sortDropdown.classList.remove('show');
                    sortOptions.forEach(opt => opt.classList.remove('active'));
                    option.classList.add('active');
                });
            });
            
            document.addEventListener('click', (e) => {
                if (!e.target.closest('.sort-container')) {
                    sortDropdown.classList.remove('show');
                }
            });
            
            aboutBtn.addEventListener('click', () => aboutModal.classList.add('active'));
            closeAboutModal.addEventListener('click', () => aboutModal.classList.remove('active'));
            aboutModal.addEventListener('click', (e) => {
                if (e.target === aboutModal) aboutModal.classList.remove('active');
            });
            
            exportBtn.addEventListener('click', () => {
                if (tracks.length === 0) {
                    showToast('Playlist is empty - nothing to export', 'warning');
                    return;
                }
                exportModal.classList.add('active');
            });
            
            closeExportModal.addEventListener('click', () => exportModal.classList.remove('active'));
            exportModal.addEventListener('click', (e) => {
                if (e.target === exportModal) exportModal.classList.remove('active');
            });
            
            selectFolderBtn.addEventListener('click', async () => {
                try {
                    const folderInput = document.createElement('input');
                    folderInput.type = 'file';
                    folderInput.webkitdirectory = true;
                    folderInput.directory = true;
                    folderInput.multiple = true;
                    folderInput.style.display = 'none';
                    
                    folderInput.addEventListener('change', (e) => {
                        if (e.target.files.length > 0) {
                            const firstFile = e.target.files[0];
                            const path = firstFile.webkitRelativePath || firstFile.name;
                            const folderName = path.split('/')[0];
                            
                            currentExportFolder = folderName;
                            folderPath.textContent = folderName;
                            selectedFolderInfo.style.display = 'block';
                            
                            showToast(`Selected folder: ${folderName}`, 'success');
                            
                            setTimeout(() => {
                                performFolderBasedExport(folderName);
                                exportModal.classList.remove('active');
                            }, 500);
                        }
                    });
                    
                    document.body.appendChild(folderInput);
                    folderInput.click();
                    setTimeout(() => {
                        if (document.body.contains(folderInput)) {
                            document.body.removeChild(folderInput);
                        }
                    }, 1000);
                    
                } catch (error) {
                    console.error('Error selecting folder:', error);
                    showToast('Could not select folder. Using simple export instead.', 'warning');
                    performSimpleExport();
                    exportModal.classList.remove('active');
                }
            });
            
            importBtn.addEventListener('click', () => {
                importInput.click();
                showToast('Select a playlist file (.json or .miaplay)', 'info');
            });
            
            importInput.addEventListener('change', handlePlaylistImport);
            
            closeImportModal.addEventListener('click', () => importModal.classList.remove('active'));
            importModal.addEventListener('click', (e) => {
                if (e.target === importModal) importModal.classList.remove('active');
            });
            
            selectImportFolderBtn.addEventListener('click', async () => {
                try {
                    const folderInput = document.createElement('input');
                    folderInput.type = 'file';
                    folderInput.webkitdirectory = true;
                    folderInput.directory = true;
                    folderInput.multiple = true;
                    folderInput.style.display = 'none';
                    
                    folderInput.addEventListener('change', async (e) => {
                        if (e.target.files.length > 0) {
                            const firstFile = e.target.files[0];
                            const path = firstFile.webkitRelativePath || firstFile.name;
                            const folderName = path.split('/')[0];
                            
                            showToast(`Searching in: ${folderName}...`, 'info');
                            importProgress.style.display = 'block';
                            
                            await restorePlaylistFromFolder(folderName, e.target.files);
                            
                            importModal.classList.remove('active');
                            importProgress.style.display = 'none';
                        }
                    });
                    
                    document.body.appendChild(folderInput);
                    folderInput.click();
                    setTimeout(() => {
                        if (document.body.contains(folderInput)) {
                            document.body.removeChild(folderInput);
                        }
                    }, 1000);
                    
                } catch (error) {
                    console.error('Error selecting import folder:', error);
                    showToast('Could not select folder. Please try manual file selection.', 'error');
                }
            });
            
            audioPlayer.addEventListener('loadedmetadata', updateDuration);
            audioPlayer.addEventListener('timeupdate', updateProgress);
            audioPlayer.addEventListener('ended', handleTrackEnd);
            audioPlayer.addEventListener('error', handleAudioError);
            
            // ========== PLAYBACK FUNCTIONS ==========
            
            function togglePlay() {
                if (tracks.length === 0) return;
                if (isPlaying) pauseAudio();
                else playAudio();
            }
            
            function playAudio() {
                if (tracks.length === 0) return;
                const track = tracks[currentTrackIndex];
                
                const audioSource = getAudioSource(track.id);
                if (!audioSource) {
                    showToast(`Cannot play: ${track.title} - Audio file missing or inaccessible`, 'error');
                    return;
                }
                
                if (!audioPlayer.src || audioPlayer.src !== audioSource) {
                    audioPlayer.src = audioSource;
                    updateTrackInfo();
                }
                
                audioPlayer.play().then(() => {
                    isPlaying = true;
                    playBtn.innerHTML = '<i class="fas fa-pause"></i>';
                    albumArtContainer.classList.add('playing');
                    highlightCurrentTrack();
                }).catch(error => {
                    showToast(`Cannot play: ${track.title}`, 'error');
                });
            }
            
            function pauseAudio() {
                audioPlayer.pause();
                isPlaying = false;
                playBtn.innerHTML = '<i class="fas fa-play"></i>';
                albumArtContainer.classList.remove('playing');
            }
            
            function playPrevious() {
                if (tracks.length === 0) return;
                currentTrackIndex = (currentTrackIndex - 1 + tracks.length) % tracks.length;
                playAudio();
                highlightCurrentTrack();
            }
            
            function playNext() {
                if (tracks.length === 0) return;
                if (isShuffled) currentTrackIndex = Math.floor(Math.random() * tracks.length);
                else currentTrackIndex = (currentTrackIndex + 1) % tracks.length;
                playAudio();
                highlightCurrentTrack();
            }
            
            function handleTrackEnd() {
                if (isRepeating) {
                    audioPlayer.currentTime = 0;
                    audioPlayer.play();
                    highlightCurrentTrack();
                } else playNext();
            }
            
            function handleAudioError() {
                const currentTrack = tracks[currentTrackIndex];
                if (currentTrack) showToast(`Error playing: ${currentTrack.title}`, 'error');
                playNext();
            }
            
            function toggleShuffle() {
                isShuffled = !isShuffled;
                shuffleBtn.style.color = isShuffled ? '#2E97F2' : 'white';
                showToast(isShuffled ? 'Shuffle enabled' : 'Shuffle disabled', 'success');
            }
            
            function toggleRepeat() {
                isRepeating = !isRepeating;
                repeatBtn.style.color = isRepeating ? '#2E97F2' : 'white';
                showToast(isRepeating ? 'Repeat enabled' : 'Repeat disabled', 'success');
            }
            
            function setProgress(e) {
                if (tracks.length === 0) return;
                const width = this.clientWidth;
                const clickX = e.offsetX;
                const duration = audioPlayer.duration;
                audioPlayer.currentTime = (clickX / width) * duration;
            }
            
            function updateProgress() {
                if (tracks.length === 0) return;
                const { currentTime, duration } = audioPlayer;
                const progressPercent = (currentTime / duration) * 100;
                progress.style.width = `${progressPercent}%`;
                currentTimeEl.textContent = formatTime(currentTime);
            }
            
            function updateDuration() {
                if (tracks.length === 0) return;
                const duration = audioPlayer.duration;
                durationEl.textContent = formatTime(duration);
                if (tracks[currentTrackIndex]) {
                    tracks[currentTrackIndex].duration = formatTime(duration);
                }
            }
            
            function updateTrackInfo() {
                if (tracks.length === 0) return;
                const track = tracks[currentTrackIndex];
                songTitle.textContent = track.title;
                songArtist.textContent = track.artist;
            }
            
            function highlightCurrentTrack() {
                const items = document.querySelectorAll('.playlist-item');
                items.forEach((item, index) => {
                    if (index === currentTrackIndex) item.classList.add('active');
                    else item.classList.remove('active');
                });
            }
            
            // ========== PERFORMANCE OPTIMIZATION ==========
            
            function cleanupPreviousBlobUrl() {
                if (activeBlobUrl) {
                    URL.revokeObjectURL(activeBlobUrl);
                    activeBlobUrl = null;
                }
            }
            
            function getAudioSource(trackId) {
                const file = trackFiles.get(trackId);
                if (!file) return null;
                
                cleanupPreviousBlobUrl();
                
                activeBlobUrl = URL.createObjectURL(file);
                return activeBlobUrl;
            }
            
            // ========== PLAYLIST MANAGEMENT ==========
            
            function renderPlaylist() {
                playlistItems.innerHTML = '';
                
                if (tracks.length === 0) {
                    playlistItems.innerHTML = `
                        <div class="empty-playlist">
                            <i class="fas fa-music"></i>
                            <p>Your playlist is empty</p>
                            <p>Add some songs to get started</p>
                        </div>
                    `;
                    return;
                }
                
                // Virtual scrolling: Show only 50 tracks at a time
                const visibleItems = tracks.slice(0, 50);
                
                visibleItems.forEach((track, index) => {
                    const item = document.createElement('div');
                    let itemClass = `playlist-item ${index === currentTrackIndex ? 'active' : ''}`;
                    item.className = itemClass;
                    item.draggable = true;
                    
                    const displayDuration = track.duration && track.duration !== '0:00' && track.duration !== 'Loading...' ? track.duration : '--:--';
                    
                    item.innerHTML = `
                        <div class="drag-handle" title="Drag to reorder">
                            <i class="fas fa-grip-lines"></i>
                        </div>
                        <div class="playlist-info">
                            <div class="playlist-title">
                                ${track.title}
                                <span class="format-badge">${track.format}</span>
                            </div>
                            <div class="playlist-artist">${track.artist}</div>
                        </div>
                        <div class="playlist-duration">${displayDuration}</div>
                        <button class="remove-btn" title="Remove song">
                            <i class="fas fa-times"></i>
                        </button>
                    `;
                    
                    item.addEventListener('click', (e) => {
                        if (!e.target.classList.contains('remove-btn') && 
                            !e.target.classList.contains('drag-handle') &&
                            !e.target.parentElement.classList.contains('drag-handle')) {
                            currentTrackIndex = index;
                            playAudio();
                            highlightCurrentTrack();
                        }
                    });
                    
                    const removeBtn = item.querySelector('.remove-btn');
                    removeBtn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        removeTrack(index);
                    });
                    
                    // Drag and drop
                    item.addEventListener('dragstart', handleDragStart);
                    item.addEventListener('dragover', handleDragOver);
                    item.addEventListener('dragenter', handleDragEnter);
                    item.addEventListener('dragleave', handleDragLeave);
                    item.addEventListener('drop', handleDrop);
                    item.addEventListener('dragend', handleDragEnd);
                    
                    playlistItems.appendChild(item);
                });
                
                // Show total count if we're not showing all items
                if (tracks.length > visibleItems.length) {
                    const countElement = document.createElement('div');
                    countElement.style.textAlign = 'center';
                    countElement.style.padding = '10px';
                    countElement.style.color = 'var(--gray)';
                    countElement.style.fontSize = '12px';
                    countElement.textContent = `Showing ${visibleItems.length} of ${tracks.length} tracks`;
                    playlistItems.appendChild(countElement);
                }
            }
            
            function removeTrack(index) {
                if (tracks.length === 0) return;
                
                const removedTrack = tracks[index];
                const wasPlaying = isPlaying && index === currentTrackIndex;
                
                trackFiles.delete(removedTrack.id);
                filePaths.delete(removedTrack.id);
                
                tracks.splice(index, 1);
                
                if (index === currentTrackIndex) {
                    if (wasPlaying) {
                        cleanupPreviousBlobUrl();
                        audioPlayer.pause();
                        isPlaying = false;
                        playBtn.innerHTML = '<i class="fas fa-play"></i>';
                        albumArtContainer.classList.remove('playing');
                    }
                    
                    if (tracks.length === 0) {
                        currentTrackIndex = 0;
                        audioPlayer.src = '';
                        updateTrackInfo();
                    } else if (currentTrackIndex >= tracks.length) {
                        currentTrackIndex = tracks.length - 1;
                    }
                } else if (index < currentTrackIndex) {
                    currentTrackIndex--;
                }
                
                renderPlaylist();
                updateTrackInfo();
                
                if (wasPlaying && tracks.length > 0) {
                    setTimeout(() => playAudio(), 100);
                }
            }
            
            function clearPlaylist() {
                if (tracks.length === 0) return;
                
                if (isPlaying) {
                    cleanupPreviousBlobUrl();
                    audioPlayer.pause();
                    isPlaying = false;
                    playBtn.innerHTML = '<i class="fas fa-play"></i>';
                    albumArtContainer.classList.remove('playing');
                }
                
                trackFiles.clear();
                filePaths.clear();
                
                tracks = [];
                currentTrackIndex = 0;
                audioPlayer.src = '';
                updateTrackInfo();
                renderPlaylist();
                
                songTitle.textContent = 'Select a song';
                songArtist.textContent = 'Artist name';
                showToast('Playlist cleared', 'success');
            }
            
            // ========== SORTING ==========
            
            function sortPlaylist(sortType) {
                if (tracks.length === 0) return;
                
                currentSort = sortType;
                const currentTrackId = tracks[currentTrackIndex]?.id;
                
                switch (sortType) {
                    case 'title':
                        tracks.sort((a, b) => a.title.localeCompare(b.title));
                        break;
                    case 'artist':
                        tracks.sort((a, b) => a.artist.localeCompare(b.artist));
                        break;
                    case 'duration':
                        tracks.sort((a, b) => {
                            const aSec = timeToSeconds(a.duration);
                            const bSec = timeToSeconds(b.duration);
                            return aSec - bSec;
                        });
                        break;
                    case 'date':
                        tracks.sort((a, b) => b.dateAdded - a.dateAdded);
                        break;
                }
                
                if (currentTrackId) {
                    const newIndex = tracks.findIndex(track => track.id === currentTrackId);
                    if (newIndex !== -1) currentTrackIndex = newIndex;
                }
                
                renderPlaylist();
                
                let sortMessage = '';
                switch (sortType) {
                    case 'title': sortMessage = 'Sorted by title'; break;
                    case 'artist': sortMessage = 'Sorted by artist'; break;
                    case 'duration': sortMessage = 'Sorted by duration (shortest first)'; break;
                    case 'date': sortMessage = 'Sorted by date added (newest first)'; break;
                }
                
                showToast(sortMessage, 'success');
            }
            
            function toggleSortDropdown() {
                sortDropdown.classList.toggle('show');
            }
            
            // ========== IMPORT/EXPORT ==========
            
            function performFolderBasedExport(folderName) {
                try {
                    const exportData = {
                        version: '4.0',
                        app: 'MiaPlay',
                        exportedAt: new Date().toISOString(),
                        trackCount: tracks.length,
                        baseFolder: folderName,
                        playlist: [],
                        note: 'Folder-based playlist. Audio files are referenced by relative path.'
                    };
                    
                    tracks.forEach((track) => {
                        const trackData = {
                            title: track.title,
                            artist: track.artist,
                            duration: track.duration,
                            format: track.format,
                            dateAdded: track.dateAdded
                        };
                        
                        const relativePath = filePaths.get(track.id);
                        if (relativePath) {
                            trackData.relativePath = relativePath;
                            trackData.fileInfo = {
                                name: track.originalFilename || track.title + '.' + track.format.toLowerCase(),
                                size: track.fileSize
                            };
                        } else {
                            trackData.note = 'No relative path available - file was added directly';
                            trackData.fileInfo = {
                                name: track.originalFilename || track.title + '.' + track.format.toLowerCase()
                            };
                        }
                        
                        exportData.playlist.push(trackData);
                    });
                    
                    const jsonData = JSON.stringify(exportData, null, 2);
                    const blob = new Blob([jsonData], { type: 'application/json' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    
                    const date = new Date();
                    const dateString = date.toISOString().split('T')[0];
                    const timeString = date.toTimeString().split(' ')[0].replace(/:/g, '-');
                    a.download = `miaplay-playlist-${dateString}_${timeString}.json`;
                    
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                    
                    showToast(`Playlist exported with ${tracks.length} track references to folder: ${folderName}`, 'success');
                    
                } catch (error) {
                    console.error('Export error:', error);
                    showToast('Failed to export playlist', 'error');
                }
            }
            
            function performSimpleExport() {
                try {
                    const exportData = {
                        version: '3.0',
                        app: 'MiaPlay',
                        exportedAt: new Date().toISOString(),
                        trackCount: tracks.length,
                        playlist: [],
                        note: 'Simple playlist export. Audio files are not referenced.'
                    };
                    
                    tracks.forEach((track) => {
                        const trackData = {
                            title: track.title,
                            artist: track.artist,
                            duration: track.duration,
                            format: track.format,
                            dateAdded: track.dateAdded,
                            fileInfo: {
                                name: track.originalFilename || track.title + '.' + track.format.toLowerCase()
                            }
                        };
                        
                        exportData.playlist.push(trackData);
                    });
                    
                    const jsonData = JSON.stringify(exportData, null, 2);
                    const blob = new Blob([jsonData], { type: 'application/json' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    
                    const date = new Date();
                    const dateString = date.toISOString().split('T')[0];
                    const timeString = date.toTimeString().split(' ')[0].replace(/:/g, '-');
                    a.download = `miaplay-playlist-${dateString}_${timeString}.json`;
                    
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                    
                    showToast(`Playlist exported with ${tracks.length} tracks (simple format)`, 'success');
                    
                } catch (error) {
                    console.error('Simple export error:', error);
                    showToast('Failed to export playlist', 'error');
                }
            }
            
            function handlePlaylistImport(event) {
                const file = event.target.files[0];
                if (!file) return;
                
                const fileName = file.name.toLowerCase();
                const isJsonFile = fileName.endsWith('.json') || fileName.endsWith('.miaplay');
                const isCorrectType = file.type === 'application/json' || file.type === '' || isJsonFile;
                
                if (!isCorrectType) {
                    showToast('Please select a valid playlist file (.json or .miaplay)', 'error');
                    importInput.value = '';
                    return;
                }
                
                const reader = new FileReader();
                
                reader.onload = async function(e) {
                    try {
                        const importData = JSON.parse(e.target.result);
                        
                        if (!importData.playlist || !Array.isArray(importData.playlist)) {
                            throw new Error('Invalid playlist file format');
                        }
                        
                        if (importData.playlist.length === 0) {
                            showToast('Imported playlist is empty', 'warning');
                            return;
                        }
                        
                        currentImportData = importData;
                        
                        if (importData.version === '4.0' && importData.baseFolder) {
                            trackCount.textContent = importData.trackCount;
                            missingCount.textContent = importData.trackCount;
                            importModal.classList.add('active');
                        } else {
                            handleOldPlaylistImport(importData);
                        }
                        
                    } catch (error) {
                        console.error('Import error:', error);
                        showToast('Failed to import playlist - file may be corrupted', 'error');
                    }
                };
                
                reader.onerror = function() {
                    showToast('Error reading playlist file', 'error');
                };
                
                reader.readAsText(file);
                importInput.value = '';
            }
            
            async function restorePlaylistFromFolder(folderName, folderFiles) {
                if (!currentImportData || !currentImportData.playlist) {
                    showToast('No import data available', 'error');
                    return;
                }
                
                let shouldClear = true;
                if (tracks.length > 0) {
                    shouldClear = confirm('Do you want to clear the current playlist and replace it with the imported one? Click OK to replace, Cancel to merge.');
                }
                
                if (isPlaying) {
                    cleanupPreviousBlobUrl();
                    audioPlayer.pause();
                    isPlaying = false;
                    playBtn.innerHTML = '<i class="fas fa-play"></i>';
                    albumArtContainer.classList.remove('playing');
                }
                
                if (shouldClear) {
                    clearPlaylist();
                }
                
                const fileMap = new Map();
                for (const file of folderFiles) {
                    const relativePath = file.webkitRelativePath || file.name;
                    fileMap.set(relativePath, file);
                    
                    const fileName = file.name.toLowerCase();
                    fileMap.set(fileName, file);
                }
                
                let restoredTracks = 0;
                let missingTracks = 0;
                const newTracks = [];
                
                for (let i = 0; i < currentImportData.playlist.length; i++) {
                    const trackData = currentImportData.playlist[i];
                    
                    const progressPercent = ((i + 1) / currentImportData.playlist.length) * 100;
                    importProgressBar.style.width = `${progressPercent}%`;
                    
                    try {
                        let file = null;
                        
                        if (trackData.relativePath) {
                            file = fileMap.get(trackData.relativePath);
                        }
                        
                        if (!file && trackData.fileInfo && trackData.fileInfo.name) {
                            const searchName = trackData.fileInfo.name.toLowerCase();
                            file = fileMap.get(searchName);
                        }
                        
                        if (file) {
                            const format = getFileFormat(file);
                            const metadata = extractMetadataFromFilename(file.name);
                            const trackId = trackIdCounter++;
                            
                            const track = {
                                id: trackId,
                                title: trackData.title || metadata.title,
                                artist: trackData.artist || metadata.artist,
                                duration: trackData.duration || 'Loading...',
                                format: format,
                                offline: false,
                                dateAdded: trackData.dateAdded || Date.now(),
                                originalFilename: file.name,
                                fileSize: file.size
                            };
                            
                            trackFiles.set(trackId, file);
                            
                            const relativePath = file.webkitRelativePath || file.name;
                            filePaths.set(trackId, relativePath);
                            
                            newTracks.push(track);
                            restoredTracks++;
                            
                            getTrackDuration(file).then(duration => {
                                track.duration = formatTime(duration);
                                renderPlaylist();
                            });
                        } else {
                            missingTracks++;
                        }
                    } catch (error) {
                        console.error('Error restoring track:', error);
                        missingTracks++;
                    }
                    
                    if (i % 5 === 0) {
                        await new Promise(resolve => setTimeout(resolve, 0));
                    }
                }
                
                tracks.push(...newTracks);
                renderPlaylist();
                updateTrackInfo();
                
                let message = `Restored ${restoredTracks} track(s) from folder`;
                if (missingTracks > 0) {
                    message += `, ${missingTracks} file(s) not found`;
                    showToast(`${missingTracks} audio file(s) could not be found in the selected folder`, 'warning');
                }
                
                showToast(message, restoredTracks > 0 ? 'success' : 'warning');
                
                currentImportData = null;
            }
            
            function handleOldPlaylistImport(importData) {
                let shouldClear = true;
                if (tracks.length > 0) {
                    shouldClear = confirm('Do you want to clear the current playlist and replace it with the imported one? Click OK to replace, Cancel to merge.');
                }
                
                if (shouldClear) {
                    clearPlaylist();
                }
                
                let importedTracks = 0;
                
                importData.playlist.forEach(trackData => {
                    const trackId = trackIdCounter++;
                    const track = {
                        id: trackId,
                        title: trackData.title || 'Unknown Title',
                        artist: trackData.artist || 'Unknown Artist',
                        duration: trackData.duration || '0:00',
                        format: trackData.format || 'Unknown',
                        offline: false,
                        dateAdded: trackData.dateAdded || Date.now(),
                        originalFilename: trackData.fileInfo?.name
                    };
                    
                    tracks.push(track);
                    importedTracks++;
                });
                
                renderPlaylist();
                updateTrackInfo();
                
                showToast(`Imported ${importedTracks} track(s) (old format - audio files need to be re-added)`, 'info');
            }
            
            // ========== UTILITY FUNCTIONS ==========
            
            function toggleMiniMode() {
                isMiniMode = !isMiniMode;
                if (isMiniMode) {
                    playerContainer.classList.add('mini-mode');
                    miniModeBtn.classList.add('active');
                    miniToggle.innerHTML = '<i class="fas fa-expand"></i>';
                    showToast('Mini Player mode activated', 'info');
                } else {
                    playerContainer.classList.remove('mini-mode');
                    miniModeBtn.classList.remove('active');
                    miniToggle.innerHTML = '<i class="fas fa-compress"></i>';
                    showToast('Mini Player mode deactivated', 'info');
                }
            }
            
            function toggleOfflineMode() {
                if (!supportsOffline) {
                    showToast('Your browser does not support advanced offline features', 'warning');
                    return;
                }
                isOfflineMode = !isOfflineMode;
                if (isOfflineMode) {
                    offlineBtn.classList.add('active');
                    showToast('Offline mode enabled', 'info');
                } else {
                    offlineBtn.classList.remove('active');
                    showToast('Offline mode disabled', 'info');
                }
                renderPlaylist();
            }
            
            function getFileFormat(file) {
                const extension = file.name.split('.').pop().toLowerCase();
                const mimeType = file.type.toLowerCase();
                for (const [mime, format] of Object.entries(SUPPORTED_FORMATS)) {
                    if (mimeType.includes(mime)) return format;
                }
                if (SUPPORTED_FORMATS[extension]) return SUPPORTED_FORMATS[extension];
                return 'Unknown';
            }
            
            // Drag and drop functionality
            function handleDragStart(e) {
                dragSrcElement = this;
                e.dataTransfer.effectAllowed = 'move';
                e.dataTransfer.setData('text/html', this.innerHTML);
                this.classList.add('dragging');
            }
            
            function handleDragOver(e) {
                if (e.preventDefault) e.preventDefault();
                e.dataTransfer.dropEffect = 'move';
                return false;
            }
            
            function handleDragEnter(e) {
                this.classList.add('drag-over');
            }
            
            function handleDragLeave(e) {
                this.classList.remove('drag-over');
            }
            
            function handleDrop(e) {
                if (e.stopPropagation) e.stopPropagation();
                if (dragSrcElement !== this) {
                    const fromIndex = Array.from(playlistItems.children).indexOf(dragSrcElement);
                    const toIndex = Array.from(playlistItems.children).indexOf(this);
                    
                    const hasCountElement = tracks.length > 50;
                    const adjustedFromIndex = hasCountElement && fromIndex >= 50 ? fromIndex - 1 : fromIndex;
                    const adjustedToIndex = hasCountElement && toIndex >= 50 ? toIndex - 1 : toIndex;
                    
                    if (adjustedFromIndex >= 0 && adjustedToIndex >= 0) {
                        const [movedTrack] = tracks.splice(adjustedFromIndex, 1);
                        tracks.splice(adjustedToIndex, 0, movedTrack);
                        
                        if (currentTrackIndex === adjustedFromIndex) currentTrackIndex = adjustedToIndex;
                        else if (currentTrackIndex > adjustedFromIndex && currentTrackIndex <= adjustedToIndex) currentTrackIndex--;
                        else if (currentTrackIndex < adjustedFromIndex && currentTrackIndex >= adjustedToIndex) currentTrackIndex++;
                        
                        renderPlaylist();
                        highlightCurrentTrack();
                    }
                }
                return false;
            }
            
            function handleDragEnd(e) {
                const items = document.querySelectorAll('.playlist-item');
                items.forEach(item => {
                    item.classList.remove('dragging');
                    item.classList.remove('drag-over');
                });
            }
            
            // Clean up on page unload
            window.addEventListener('beforeunload', () => {
                cleanupPreviousBlobUrl();
            });
        });
    </script>
</body>
</html>
