<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MiaPlay</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        :root {
            --primary: #2E97F2;
            --secondary: #FF0000;
            --dark: #121212;
            --darker: #0a0a0a;
            --light: #ffffff;
            --gray: #a0a0a0;
            --danger: #ff4757;
            --warning: #ffa502;
            --success: #2ed573;
        }

        body {
            background: linear-gradient(135deg, var(--darker), #1a1a2e);
            color: var(--light);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .player-container {
            width: 100%;
            max-width: 900px;
            background: rgba(18, 18, 18, 0.85);
            border-radius: 24px;
            overflow: hidden;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.05);
            transition: all 0.3s ease;
        }

        /* Mini Player Styles */
        .player-container.mini-mode {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 300px;
            max-width: 300px;
            z-index: 1000;
            animation: slideInUp 0.3s ease;
        }

        @keyframes slideInUp {
            from {
                transform: translateY(100px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .mini-player-controls {
            display: none;
            position: absolute;
            top: 10px;
            right: 10px;
            gap: 5px;
            z-index: 1001;
        }

        .player-container.mini-mode .mini-player-controls {
            display: flex;
        }

        .mini-control-btn {
            background: rgba(0, 0, 0, 0.7);
            border: none;
            color: white;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
        }

        .mini-control-btn:hover {
            background: rgba(0, 0, 0, 0.9);
            transform: scale(1.1);
        }

        .player-container.mini-mode .player-header,
        .player-container.mini-mode .playlist,
        .player-container.mini-mode .file-upload,
        .player-container.mini-mode .player-footer {
            display: none;
        }

        .player-container.mini-mode .player-body {
            flex-direction: row;
            padding: 10px;
            align-items: center;
        }

        .player-container.mini-mode .now-playing {
            flex-direction: row;
            padding: 0;
            width: 100%;
            gap: 15px;
            align-items: center;
        }

        .player-container.mini-mode .album-art-container {
            width: 50px;
            height: 50px;
            margin-bottom: 0;
            flex-shrink: 0;
        }

        .player-container.mini-mode .album-art i {
            font-size: 20px;
        }

        .player-container.mini-mode .song-info {
            flex: 1;
            margin-bottom: 0;
            text-align: left;
            min-width: 0;
        }

        .player-container.mini-mode .song-title {
            font-size: 14px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .player-container.mini-mode .song-artist {
            font-size: 12px;
        }

        .player-container.mini-mode .progress-container {
            display: none;
        }

        .player-container.mini-mode .controls {
            margin: 0;
            gap: 8px;
        }

        .player-container.mini-mode .control-btn {
            width: 35px;
            height: 35px;
            font-size: 14px;
        }

        .player-container.mini-mode .play-btn {
            width: 40px;
            height: 40px;
            font-size: 16px;
        }

        .player-container.mini-mode .volume-control {
            display: none;
        }

        .mini-toggle {
            position: absolute;
            top: 15px;
            right: 15px;
            background: rgba(255, 255, 255, 0.1);
            border: none;
            color: var(--gray);
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 14px;
        }

        .mini-toggle:hover {
            background: rgba(255, 255, 255, 0.2);
            color: var(--light);
        }

        .player-header {
            padding: 20px 25px;
            text-align: center;
            background: rgba(0, 0, 0, 0.3);
            position: relative;
            overflow: hidden;
        }

        .player-header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(to right, var(--primary), var(--secondary));
        }

        .player-header h1 {
            font-size: 28px;
            margin-bottom: 6px;
            background: linear-gradient(to right, var(--primary), var(--secondary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            font-weight: 700;
        }

        .player-header p {
            color: var(--gray);
            font-size: 14px;
            letter-spacing: 1px;
        }

        .player-body {
            display: flex;
            flex-direction: column;
            padding: 15px;
            gap: 15px;
        }

        @media (min-width: 768px) {
            .player-body {
                flex-direction: row;
                gap: 20px;
            }
        }

        /* FIXED: Now-playing section with proper width constraints */
        .now-playing {
            flex: 1;
            min-width: 280px;
            max-width: 400px;
            padding: 15px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .album-art-container {
            position: relative;
            width: 160px;
            height: 160px;
            margin-bottom: 20px;
        }

        .album-art {
            width: 100%;
            height: 100%;
            border-radius: 16px;
            background: linear-gradient(45deg, var(--primary), var(--secondary));
            display: flex;
            justify-content: center;
            align-items: center;
            box-shadow: 0 10px 25px rgba(46, 151, 242, 0.3);
            overflow: hidden;
            position: relative;
        }

        .album-art::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, rgba(46, 151, 242, 0.2), rgba(255, 0, 0, 0.2));
        }

        .album-art i {
            font-size: 50px;
            color: rgba(255, 255, 255, 0.8);
            z-index: 1;
        }

        .song-info {
            text-align: center;
            margin-bottom: 18px;
            width: 100%;
            min-width: 0;
        }

        /* FIXED: Better text truncation for long titles */
        .song-title {
            font-size: 22px;
            font-weight: bold;
            margin-bottom: 6px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 100%;
            padding: 0 10px;
        }

        .song-artist {
            font-size: 16px;
            color: var(--gray);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 100%;
            padding: 0 10px;
        }

        .progress-container {
            width: 100%;
            margin: 18px 0;
        }

        .progress-bar {
            width: 100%;
            height: 6px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 3px;
            cursor: pointer;
            position: relative;
            overflow: hidden;
        }

        .progress {
            height: 100%;
            background: linear-gradient(to right, var(--primary), var(--secondary));
            border-radius: 3px;
            width: 0%;
            transition: width 0.1s linear;
            position: relative;
        }

        .progress::after {
            content: '';
            position: absolute;
            top: 0;
            right: 0;
            width: 12px;
            height: 12px;
            background: white;
            border-radius: 50%;
            transform: translate(50%, -25%);
            box-shadow: 0 0 10px rgba(255, 255, 255, 0.8);
        }

        .time-display {
            display: flex;
            justify-content: space-between;
            margin-top: 8px;
            font-size: 13px;
            color: var(--gray);
        }

        .controls {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 15px;
            margin: 18px 0;
        }

        .control-btn {
            background: rgba(255, 255, 255, 0.1);
            border: none;
            color: white;
            font-size: 18px;
            cursor: pointer;
            transition: all 0.3s ease;
            width: 45px;
            height: 45px;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            backdrop-filter: blur(5px);
        }

        .control-btn:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: scale(1.05);
        }

        .play-btn {
            background: linear-gradient(45deg, var(--primary), var(--secondary));
            width: 65px;
            height: 65px;
            font-size: 26px;
            box-shadow: 0 5px 15px rgba(46, 151, 242, 0.4);
        }

        .play-btn:hover {
            transform: scale(1.08);
            box-shadow: 0 8px 20px rgba(46, 151, 242, 0.6);
        }

        .volume-control {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 12px;
            width: 100%;
        }

        .volume-slider {
            flex: 1;
            height: 5px;
            -webkit-appearance: none;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 3px;
            outline: none;
        }

        .volume-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: var(--primary);
            cursor: pointer;
            box-shadow: 0 0 10px rgba(46, 151, 242, 0.8);
        }

        /* FIXED: Playlist section with proper width constraints */
        .playlist {
            flex: 1.2;
            min-width: 300px;
            max-width: 500px;
            padding: 18px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 16px;
            max-height: 420px;
            overflow-y: auto;
            overflow-x: hidden;
            position: relative;
        }

        .playlist-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 18px;
            gap: 10px;
            flex-wrap: wrap;
        }

        .playlist h2 {
            font-size: 20px;
            color: var(--primary);
            display: flex;
            align-items: center;
            gap: 8px;
            white-space: nowrap;
        }

        .playlist h2 i {
            font-size: 18px;
        }

        /* FIXED: Improved playlist actions layout */
        .playlist-actions {
            display: flex;
            gap: 5px;
            flex-wrap: wrap;
            justify-content: flex-end;
            flex: 1;
            min-width: 0;
        }

        .action-btn {
            background: rgba(255, 255, 255, 0.1);
            border: none;
            color: white;
            padding: 7px 10px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 4px;
            white-space: nowrap;
            flex-shrink: 0;
        }

        /* FIXED: Icon-only buttons for mobile, text for desktop */
        .action-btn.icon-only {
            padding: 7px;
            min-width: 34px;
            justify-content: center;
        }

        .action-btn.icon-only .btn-text {
            display: none;
        }

        @media (min-width: 480px) {
            .action-btn.icon-only {
                padding: 7px 10px;
                min-width: auto;
                justify-content: flex-start;
            }
            .action-btn.icon-only .btn-text {
                display: inline;
            }
        }

        .action-btn:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .clear-btn {
            background: rgba(255, 71, 87, 0.2);
            color: var(--danger);
        }

        .clear-btn:hover {
            background: rgba(255, 71, 87, 0.3);
        }

        .offline-btn {
            background: rgba(46, 151, 242, 0.2);
            color: var(--primary);
        }

        .offline-btn:hover {
            background: rgba(46, 151, 242, 0.3);
        }

        .offline-btn.active {
            background: rgba(46, 151, 242, 0.4);
            color: var(--light);
        }

        .mini-btn {
            background: rgba(255, 255, 255, 0.1);
            color: white;
        }

        .mini-btn:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .mini-btn.active {
            background: rgba(46, 151, 242, 0.4);
            color: var(--light);
        }

        .sort-btn {
            background: rgba(255, 255, 255, 0.1);
            color: white;
            position: relative;
        }

        .sort-btn:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .sort-dropdown {
            position: absolute;
            top: 100%;
            right: 0;
            background: var(--dark);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            padding: 8px;
            min-width: 150px;
            z-index: 100;
            display: none;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3);
        }

        .sort-dropdown.show {
            display: block;
        }

        .sort-option {
            background: none;
            border: none;
            color: var(--gray);
            padding: 8px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            width: 100%;
            text-align: left;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.2s ease;
        }

        .sort-option:hover {
            background: rgba(255, 255, 255, 0.1);
            color: var(--light);
        }

        .sort-option.active {
            color: var(--primary);
            background: rgba(46, 151, 242, 0.1);
        }

        .playlist-item {
            display: flex;
            align-items: center;
            padding: 10px 12px;
            border-radius: 10px;
            margin-bottom: 6px;
            cursor: grab;
            transition: all 0.2s ease;
            border-left: 3px solid transparent;
            position: relative;
            user-select: none;
        }

        .playlist-item:active {
            cursor: grabbing;
        }

        .playlist-item.dragging {
            opacity: 0.5;
            transform: scale(0.98);
        }

        .playlist-item:hover {
            background: rgba(255, 255, 255, 0.05);
            transform: translateX(5px);
        }

        .playlist-item:hover .remove-btn {
            opacity: 1;
        }

        .playlist-item.active {
            background: rgba(46, 151, 242, 0.15);
            border-left: 3px solid var(--primary);
        }

        .playlist-item.offline {
            border-left: 3px solid var(--success);
        }

        .playlist-item img {
            width: 40px;
            height: 40px;
            border-radius: 8px;
            margin-right: 12px;
            object-fit: cover;
        }

        .playlist-info {
            flex: 1;
            min-width: 0;
        }

        .playlist-title {
            font-weight: bold;
            margin-bottom: 3px;
            font-size: 14px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .playlist-artist {
            font-size: 12px;
            color: var(--gray);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .playlist-duration {
            font-size: 12px;
            color: var(--gray);
            margin-right: 8px;
            flex-shrink: 0;
        }

        .format-badge {
            background: rgba(46, 151, 242, 0.3);
            color: var(--primary);
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 9px;
            font-weight: bold;
            margin-left: 6px;
        }

        .offline-badge {
            background: rgba(46, 214, 115, 0.3);
            color: var(--success);
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 9px;
            font-weight: bold;
            margin-left: 6px;
        }

        .drag-handle {
            color: var(--gray);
            margin-right: 8px;
            cursor: grab;
            font-size: 12px;
            flex-shrink: 0;
        }

        .drag-handle:active {
            cursor: grabbing;
        }

        .remove-btn {
            background: rgba(255, 71, 87, 0.2);
            border: none;
            color: var(--danger);
            width: 26px;
            height: 26px;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            transition: all 0.3s ease;
            opacity: 0;
            font-size: 11px;
            flex-shrink: 0;
        }

        .remove-btn:hover {
            background: rgba(255, 71, 87, 0.8);
            color: white;
            transform: scale(1.1);
        }

        /* Scrollbar styling */
        .playlist::-webkit-scrollbar {
            width: 6px;
        }

        .playlist::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 3px;
        }

        .playlist::-webkit-scrollbar-thumb {
            background: var(--primary);
            border-radius: 3px;
        }

        .playlist::-webkit-scrollbar-thumb:hover {
            background: var(--secondary);
        }

        .file-upload {
            text-align: center;
            margin-top: 18px;
            padding: 12px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .upload-btn {
            background: linear-gradient(45deg, var(--primary), var(--secondary));
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 50px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            box-shadow: 0 5px 15px rgba(46, 151, 242, 0.4);
            font-size: 14px;
        }

        .upload-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(46, 151, 242, 0.6);
        }

        #file-input {
            display: none;
        }

        .player-footer {
            padding: 12px;
            text-align: center;
            color: var(--gray);
            font-size: 13px;
            border-top: 1px solid rgba(255, 255, 255, 0.05);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 10px;
        }

        .footer-info {
            display: flex;
            gap: 15px;
        }

        .info-btn {
            background: none;
            border: none;
            color: var(--gray);
            font-size: 12px;
            cursor: pointer;
            transition: color 0.3s ease;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .info-btn:hover {
            color: var(--primary);
        }

        .empty-playlist {
            text-align: center;
            padding: 30px 15px;
            color: var(--gray);
        }

        .empty-playlist i {
            font-size: 40px;
            margin-bottom: 12px;
            opacity: 0.5;
        }

        .empty-playlist p {
            font-size: 14px;
            margin-bottom: 5px;
        }

        .supported-formats {
            margin-top: 8px;
            font-size: 11px;
            color: var(--gray);
            text-align: center;
            width: 100%;
        }

        .supported-formats span {
            color: var(--primary);
            font-weight: bold;
        }

        /* Toast notification */
        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 12px 18px;
            border-radius: 8px;
            color: white;
            font-weight: 500;
            z-index: 1000;
            transform: translateX(400px);
            transition: transform 0.3s ease;
            max-width: 300px;
            font-size: 14px;
        }

        .toast.show {
            transform: translateX(0);
        }

        .toast.error {
            background: var(--danger);
        }

        .toast.warning {
            background: var(--warning);
            color: #333;
        }

        .toast.success {
            background: var(--success);
        }

        .toast.info {
            background: var(--primary);
        }

        /* Modal Styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }

        .modal-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .modal {
            background: var(--dark);
            border-radius: 16px;
            padding: 24px;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow: hidden;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.5);
            border: 1px solid rgba(255, 255, 255, 0.1);
            transform: scale(0.9);
            transition: transform 0.3s ease;
        }

        .modal-overlay.active .modal {
            transform: scale(1);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-header h3 {
            color: var(--primary);
            font-size: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .close-modal {
            background: none;
            border: none;
            color: var(--gray);
            font-size: 20px;
            cursor: pointer;
            transition: color 0.3s ease;
        }

        .close-modal:hover {
            color: var(--light);
        }

        .modal-content {
            line-height: 1.6;
            color: var(--gray);
        }

        .modal-content p {
            margin-bottom: 15px;
        }

        .modal-content ul {
            margin-left: 20px;
            margin-bottom: 15px;
        }

        .modal-content li {
            margin-bottom: 8px;
        }

        .feature-list {
            background: rgba(255, 255, 255, 0.05);
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
        }

        .progress-indicator {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-top: 10px;
            font-size: 12px;
            color: var(--gray);
        }

        .progress-bar-small {
            flex: 1;
            height: 4px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 2px;
            overflow: hidden;
        }

        .progress-small {
            height: 100%;
            background: var(--primary);
            width: 0%;
            transition: width 0.3s ease;
        }

        /* NEW: Export/Import Styles */
        .export-import-btns {
            display: flex;
            gap: 5px;
        }
        
        .export-btn, .import-btn {
            background: rgba(46, 151, 242, 0.2);
            color: var(--primary);
        }
        
        .export-btn:hover, .import-btn:hover {
            background: rgba(46, 151, 242, 0.3);
        }
        
        #import-input {
            display: none;
        }
        
        .feature-highlight {
            background: rgba(46, 151, 242, 0.1);
            border-left: 3px solid var(--primary);
            padding: 10px 15px;
            margin: 15px 0;
            border-radius: 0 8px 8px 0;
        }

        /* Tooltip for icon buttons */
        .tooltip {
            position: relative;
        }

        .tooltip::after {
            content: attr(title);
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 5px 10px;
            border-radius: 4px;
            font-size: 12px;
            white-space: nowrap;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
            z-index: 1000;
        }

        .tooltip:hover::after {
            opacity: 1;
        }
    </style>
</head>
<body>
    <div class="toast" id="toast"></div>
    
    <!-- About Modal -->
    <div class="modal-overlay" id="about-modal">
        <div class="modal">
            <div class="modal-header">
                <h3><i class="fas fa-info-circle"></i> About MiaPlay</h3>
                <button class="close-modal" id="close-about">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-content">
                <p><strong>MiaPlay</strong> is a modern, browser-based music player designed for simplicity and elegance. Enjoy your music collection with an intuitive interface that puts the focus on what matters most - your music.</p>
                
                <div class="feature-list">
                    <p><strong>Key Features:</strong></p>
                    <ul>
                        <li>Multi-format audio support (MP3, WAV, OGG, M4A, WebM, FLAC)</li>
                        <li>Drag & drop playlist management</li>
                        <li>Offline playback support</li>
                        <li>Mini Player mode</li>
                        <li>Playlist sorting (title, artist, duration, date added)</li>
                        <li><strong>Playlist Export/Import</strong> - Save and load your playlists</li>
                        <li>Clean, responsive design</li>
                        <li>No installation required</li>
                    </ul>
                </div>
                
                <div class="feature-highlight">
                    <p><strong>New: Playlist Export/Import</strong></p>
                    <p>Save your carefully curated playlists as files and load them anytime! Your playlist data stays on your device - we don't upload anything to servers.</p>
                </div>
                
                <p>MiaPlay works entirely in your browser - your files never leave your device. Simply add your audio files and start listening!</p>
            </div>
        </div>
    </div>
    
    <div class="player-container" id="player-container">
        <button class="mini-toggle" id="mini-toggle" title="Toggle Mini Player">
            <i class="fas fa-compress"></i>
        </button>
        
        <div class="mini-player-controls">
            <button class="mini-control-btn" id="mini-close" title="Close Mini Player">
                <i class="fas fa-times"></i>
            </button>
        </div>
        
        <div class="player-header">
            <h1>MiaPlay</h1>
            <p>Sound | Listen | Play</p>
        </div>
        
        <div class="player-body">
            <div class="now-playing">
                <div class="album-art-container" id="album-art-container">
                    <div class="album-art">
                        <i class="fas fa-music"></i>
                    </div>
                </div>
                
                <div class="song-info">
                    <div class="song-title" id="song-title">Select a song</div>
                    <div class="song-artist" id="song-artist">Artist name</div>
                </div>
                
                <div class="progress-container">
                    <div class="progress-bar" id="progress-bar">
                        <div class="progress" id="progress"></div>
                    </div>
                    <div class="time-display">
                        <span id="current-time">0:00</span>
                        <span id="duration">0:00</span>
                    </div>
                </div>
                
                <div class="controls">
                    <button class="control-btn" id="shuffle-btn" title="Shuffle">
                        <i class="fas fa-random"></i>
                    </button>
                    <button class="control-btn" id="prev-btn" title="Previous">
                        <i class="fas fa-step-backward"></i>
                    </button>
                    <button class="control-btn play-btn" id="play-btn" title="Play">
                        <i class="fas fa-play"></i>
                    </button>
                    <button class="control-btn" id="next-btn" title="Next">
                        <i class="fas fa-step-forward"></i>
                    </button>
                    <button class="control-btn" id="repeat-btn" title="Repeat">
                        <i class="fas fa-redo"></i>
                    </button>
                </div>
                
                <div class="volume-control">
                    <i class="fas fa-volume-down"></i>
                    <input type="range" class="volume-slider" id="volume-slider" min="0" max="100" value="50">
                    <i class="fas fa-volume-up"></i>
                </div>
                
                <div class="file-upload">
                    <button class="upload-btn" id="upload-btn">
                        <i class="fas fa-plus"></i> Add Audio Files
                    </button>
                    <input type="file" id="file-input" accept="audio/mp3, audio/mpeg, audio/wav, audio/ogg, audio/webm, audio/flac, audio/aac, audio/m4a, audio/x-m4a" multiple>
                    <div class="supported-formats">
                        Supported: <span>MP3, WAV, OGG, M4A, WebM, FLAC</span>
                    </div>
                </div>
            </div>
            
            <div class="playlist">
                <div class="playlist-header">
                    <h2><i class="fas fa-list"></i> Playlist</h2>
                    <div class="playlist-actions">
                        <div class="export-import-btns">
                            <button class="action-btn export-btn tooltip icon-only" id="export-btn" title="Export Playlist">
                                <i class="fas fa-share"></i>
                                <span class="btn-text">Export</span>
                            </button>
                            <button class="action-btn import-btn tooltip icon-only" id="import-btn" title="Import Playlist">
                                <i class="fas fa-file-import"></i>
                                <span class="btn-text">Import</span>
                            </button>
                            <input type="file" id="import-input" accept=".json,.miaplay">
                        </div>
                        <div class="sort-container" style="position: relative;">
                            <button class="action-btn sort-btn tooltip icon-only" id="sort-btn" title="Sort Playlist">
                                <i class="fas fa-sort"></i>
                                <span class="btn-text">Sort</span>
                            </button>
                            <div class="sort-dropdown" id="sort-dropdown">
                                <button class="sort-option" data-sort="title">
                                    <i class="fas fa-font"></i> Title
                                </button>
                                <button class="sort-option" data-sort="artist">
                                    <i class="fas fa-user"></i> Artist
                                </button>
                                <button class="sort-option" data-sort="duration">
                                    <i class="fas fa-clock"></i> Duration
                                </button>
                                <button class="sort-option" data-sort="date">
                                    <i class="fas fa-calendar"></i> Date Added
                                </button>
                            </div>
                        </div>
                        <button class="action-btn mini-btn tooltip icon-only" id="mini-mode-btn" title="Mini Player Mode">
                            <i class="fas fa-compress"></i>
                            <span class="btn-text">Mini</span>
                        </button>
                        <button class="action-btn offline-btn tooltip icon-only" id="offline-btn" title="Enable offline mode">
                            <i class="fas fa-download"></i>
                            <span class="btn-text">Offline</span>
                        </button>
                        <button class="action-btn clear-btn tooltip icon-only" id="clear-btn" title="Clear playlist">
                            <i class="fas fa-trash"></i>
                            <span class="btn-text">Clear All</span>
                        </button>
                    </div>
                </div>
                <div id="playlist-items">
                    <div class="empty-playlist">
                        <i class="fas fa-music"></i>
                        <p>Your playlist is empty</p>
                        <p>Add some songs to get started</p>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="player-footer">
            <div class="footer-info">
                <button class="info-btn" id="about-btn">
                    <i class="fas fa-info-circle"></i> About MiaPlay
                </button>
            </div>
            <p>MiaPlay Â© 2025</p>
            <div class="progress-indicator" id="offline-progress" style="display: none;">
                <span>Caching...</span>
                <div class="progress-bar-small">
                    <div class="progress-small" id="offline-progress-bar"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // DOM Elements
            const audioPlayer = new Audio();
            const playerContainer = document.getElementById('player-container');
            const playBtn = document.getElementById('play-btn');
            const prevBtn = document.getElementById('prev-btn');
            const nextBtn = document.getElementById('next-btn');
            const shuffleBtn = document.getElementById('shuffle-btn');
            const repeatBtn = document.getElementById('repeat-btn');
            const progressBar = document.getElementById('progress-bar');
            const progress = document.getElementById('progress');
            const currentTimeEl = document.getElementById('current-time');
            const durationEl = document.getElementById('duration');
            const volumeSlider = document.getElementById('volume-slider');
            const playlistItems = document.getElementById('playlist-items');
            const fileInput = document.getElementById('file-input');
            const uploadBtn = document.getElementById('upload-btn');
            const offlineBtn = document.getElementById('offline-btn');
            const miniModeBtn = document.getElementById('mini-mode-btn');
            const miniToggle = document.getElementById('mini-toggle');
            const miniClose = document.getElementById('mini-close');
            const sortBtn = document.getElementById('sort-btn');
            const sortDropdown = document.getElementById('sort-dropdown');
            const sortOptions = document.querySelectorAll('.sort-option');
            const clearBtn = document.getElementById('clear-btn');
            const aboutBtn = document.getElementById('about-btn');
            const songTitle = document.getElementById('song-title');
            const songArtist = document.getElementById('song-artist');
            const albumArtContainer = document.getElementById('album-art-container');
            const toast = document.getElementById('toast');
            const offlineProgress = document.getElementById('offline-progress');
            const offlineProgressBar = document.getElementById('offline-progress-bar');
            
            // NEW: Export/Import Elements
            const exportBtn = document.getElementById('export-btn');
            const importBtn = document.getElementById('import-btn');
            const importInput = document.getElementById('import-input');
            
            // Modal Elements
            const aboutModal = document.getElementById('about-modal');
            const closeAboutModal = document.getElementById('close-about');
            
            // Supported audio formats
            const SUPPORTED_FORMATS = {
                'mp3': 'MP3',
                'mpeg': 'MP3', 
                'wav': 'WAV',
                'ogg': 'OGG',
                'webm': 'WebM',
                'flac': 'FLAC',
                'aac': 'AAC',
                'm4a': 'M4A',
                'x-m4a': 'M4A'
            };
            
            // Player state
            let isPlaying = false;
            let currentTrackIndex = 0;
            let isShuffled = false;
            let isRepeating = false;
            let isOfflineMode = false;
            let isMiniMode = false;
            let currentSort = 'date';
            let tracks = [];
            let dragSrcElement = null;

            // FIXED: Audio state preservation variables
            let currentPlaybackTime = 0;
            let wasPlayingBeforeModification = false;
            
            // Check if browser supports service workers for advanced offline features
            const supportsOffline = 'serviceWorker' in navigator && 'caches' in window;
            
            // Event Listeners
            playBtn.addEventListener('click', togglePlay);
            prevBtn.addEventListener('click', playPrevious);
            nextBtn.addEventListener('click', playNext);
            shuffleBtn.addEventListener('click', toggleShuffle);
            repeatBtn.addEventListener('click', toggleRepeat);
            progressBar.addEventListener('click', setProgress);
            volumeSlider.addEventListener('input', setVolume);
            
            // File upload events
            uploadBtn.addEventListener('click', () => {
                fileInput.click();
                showToast('Select audio files from your device', 'info');
            });
            
            fileInput.addEventListener('change', handleFileUpload);
            clearBtn.addEventListener('click', clearPlaylist);
            
            // Offline mode
            offlineBtn.addEventListener('click', toggleOfflineMode);
            
            // Mini Player mode
            miniModeBtn.addEventListener('click', toggleMiniMode);
            miniToggle.addEventListener('click', toggleMiniMode);
            miniClose.addEventListener('click', toggleMiniMode);
            
            // Playlist sorting
            sortBtn.addEventListener('click', toggleSortDropdown);
            
            sortOptions.forEach(option => {
                option.addEventListener('click', () => {
                    const sortType = option.dataset.sort;
                    sortPlaylist(sortType);
                    sortDropdown.classList.remove('show');
                    
                    // Update active state
                    sortOptions.forEach(opt => opt.classList.remove('active'));
                    option.classList.add('active');
                });
            });
            
            // Close dropdown when clicking outside
            document.addEventListener('click', (e) => {
                if (!e.target.closest('.sort-container')) {
                    sortDropdown.classList.remove('show');
                }
            });
            
            // About modal
            aboutBtn.addEventListener('click', () => aboutModal.classList.add('active'));
            closeAboutModal.addEventListener('click', () => aboutModal.classList.remove('active'));
            aboutModal.addEventListener('click', (e) => {
                if (e.target === aboutModal) aboutModal.classList.remove('active');
            });
            
            // NEW: Export/Import Event Listeners
            exportBtn.addEventListener('click', exportPlaylist);
            importBtn.addEventListener('click', () => {
                importInput.click();
                showToast('Select a MiaPlay playlist file (.json or .miaplay)', 'info');
            });
            importInput.addEventListener('change', handlePlaylistImport);
            
            // Audio event listeners
            audioPlayer.addEventListener('loadedmetadata', updateDuration);
            audioPlayer.addEventListener('timeupdate', updateProgress);
            audioPlayer.addEventListener('ended', handleTrackEnd);
            audioPlayer.addEventListener('error', handleAudioError);

            // FIXED: Track current playback time for state preservation
            audioPlayer.addEventListener('timeupdate', () => {
                currentPlaybackTime = audioPlayer.currentTime;
            });
            
            // Functions
            function showToast(message, type = 'error') {
                toast.textContent = message;
                toast.className = `toast ${type} show`;
                setTimeout(() => {
                    toast.classList.remove('show');
                }, 4000);
            }
            
            // NEW: Export Playlist Function
            function exportPlaylist() {
                if (tracks.length === 0) {
                    showToast('Playlist is empty - nothing to export', 'warning');
                    return;
                }
                
                try {
                    // Create export data structure
                    const exportData = {
                        version: '1.0',
                        app: 'MiaPlay',
                        exportedAt: new Date().toISOString(),
                        trackCount: tracks.length,
                        playlist: tracks.map(track => ({
                            title: track.title,
                            artist: track.artist,
                            src: track.src,
                            duration: track.duration,
                            format: track.format,
                            offline: track.offline,
                            dateAdded: track.dateAdded
                        }))
                    };
                    
                    // Convert to JSON string
                    const jsonData = JSON.stringify(exportData, null, 2);
                    
                    // Create download link
                    const blob = new Blob([jsonData], { type: 'application/json' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    
                    // Create filename with current date
                    const date = new Date();
                    const dateString = date.toISOString().split('T')[0];
                    const timeString = date.toTimeString().split(' ')[0].replace(/:/g, '-');
                    a.download = `miaplay-playlist-${dateString}_${timeString}.miaplay`;
                    
                    // Trigger download
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                    
                    showToast(`Playlist exported with ${tracks.length} tracks`, 'success');
                } catch (error) {
                    console.error('Export error:', error);
                    showToast('Failed to export playlist', 'error');
                }
            }
            
            // NEW: Import Playlist Function
            function handlePlaylistImport(event) {
                const file = event.target.files[0];
                if (!file) return;
                
                const reader = new FileReader();
                
                reader.onload = function(e) {
                    try {
                        const importData = JSON.parse(e.target.result);
                        
                        // Validate import file structure
                        if (!importData.playlist || !Array.isArray(importData.playlist)) {
                            throw new Error('Invalid playlist file format');
                        }
                        
                        if (importData.playlist.length === 0) {
                            showToast('Imported playlist is empty', 'warning');
                            return;
                        }
                        
                        // Check if we should clear current playlist or merge
                        let shouldClear = true;
                        if (tracks.length > 0) {
                            shouldClear = confirm('Do you want to clear the current playlist and replace it with the imported one? Click OK to replace, Cancel to merge.');
                        }
                        
                        // FIXED: Preserve playback state before modification
                        const wasPlaying = isPlaying;
                        const currentTime = audioPlayer.currentTime;
                        const currentSrc = audioPlayer.src;
                        
                        // Stop current playback if clearing
                        if (shouldClear && isPlaying) {
                            audioPlayer.pause();
                            isPlaying = false;
                            playBtn.innerHTML = '<i class="fas fa-play"></i>';
                            albumArtContainer.classList.remove('playing');
                        }
                        
                        // Clear tracks if requested
                        if (shouldClear) {
                            tracks = [];
                            currentTrackIndex = 0;
                        }
                        
                        let validTracks = 0;
                        let invalidTracks = 0;
                        
                        // Process imported tracks
                        importData.playlist.forEach(trackData => {
                            // Basic validation
                            if (trackData.src && trackData.title) {
                                const track = {
                                    title: trackData.title || 'Unknown Title',
                                    artist: trackData.artist || 'Unknown Artist',
                                    src: trackData.src,
                                    duration: trackData.duration || '0:00',
                                    format: trackData.format || 'Unknown',
                                    offline: trackData.offline || false,
                                    dateAdded: trackData.dateAdded || Date.now()
                                };
                                
                                tracks.push(track);
                                validTracks++;
                            } else {
                                invalidTracks++;
                            }
                        });
                        
                        // Update UI
                        renderPlaylist();
                        updateTrackInfo();
                        
                        // FIXED: Restore playback state if not clearing or if current track still exists
                        if (!shouldClear && wasPlaying && currentSrc) {
                            // Try to find the current track in the new playlist
                            const currentTrackStillExists = tracks.some(track => track.src === currentSrc);
                            if (currentTrackStillExists) {
                                setTimeout(() => {
                                    audioPlayer.currentTime = currentTime;
                                    if (wasPlaying) {
                                        audioPlayer.play().catch(e => console.log('Auto-play prevented'));
                                    }
                                }, 100);
                            }
                        }
                        
                        // Show results
                        let message = `Imported ${validTracks} track(s)`;
                        if (invalidTracks > 0) {
                            message += `, ${invalidTracks} invalid track(s) skipped`;
                        }
                        if (!shouldClear) {
                            message += ' (merged with existing playlist)';
                        }
                        
                        showToast(message, 'success');
                        
                    } catch (error) {
                        console.error('Import error:', error);
                        showToast('Failed to import playlist - file may be corrupted', 'error');
                    }
                };
                
                reader.onerror = function() {
                    showToast('Error reading playlist file', 'error');
                };
                
                reader.readAsText(file);
                importInput.value = ''; // Reset file input
            }
            
            function toggleSortDropdown() {
                sortDropdown.classList.toggle('show');
            }
            
            function sortPlaylist(sortType) {
                if (tracks.length === 0) return;
                
                currentSort = sortType;
                
                // Save current track before sorting
                const currentTrack = tracks[currentTrackIndex];
                
                switch (sortType) {
                    case 'title':
                        tracks.sort((a, b) => a.title.localeCompare(b.title));
                        break;
                    case 'artist':
                        tracks.sort((a, b) => a.artist.localeCompare(b.artist));
                        break;
                    case 'duration':
                        tracks.sort((a, b) => a.title.localeCompare(b.title));
                        break;
                    case 'date':
                        break;
                }
                
                // Find the new index of the currently playing track
                const newIndex = tracks.findIndex(track => 
                    track.title === currentTrack.title && 
                    track.artist === currentTrack.artist
                );
                
                if (newIndex !== -1) {
                    currentTrackIndex = newIndex;
                }
                
                renderPlaylist();
                
                let sortMessage = '';
                switch (sortType) {
                    case 'title': sortMessage = 'Sorted by title'; break;
                    case 'artist': sortMessage = 'Sorted by artist'; break;
                    case 'duration': sortMessage = 'Sorted by duration'; break;
                    case 'date': sortMessage = 'Sorted by date added'; break;
                }
                
                showToast(sortMessage, 'success');
            }
            
            function toggleMiniMode() {
                isMiniMode = !isMiniMode;
                
                if (isMiniMode) {
                    playerContainer.classList.add('mini-mode');
                    miniModeBtn.classList.add('active');
                    miniToggle.innerHTML = '<i class="fas fa-expand"></i>';
                    showToast('Mini Player mode activated', 'info');
                } else {
                    playerContainer.classList.remove('mini-mode');
                    miniModeBtn.classList.remove('active');
                    miniToggle.innerHTML = '<i class="fas fa-compress"></i>';
                    showToast('Mini Player mode deactivated', 'info');
                }
            }
            
            function toggleOfflineMode() {
                if (!supportsOffline) {
                    showToast('Your browser does not support advanced offline features', 'warning');
                    return;
                }
                
                isOfflineMode = !isOfflineMode;
                
                if (isOfflineMode) {
                    offlineBtn.classList.add('active');
                    showToast('Offline mode enabled - caching tracks...', 'info');
                    cacheTracksForOffline();
                } else {
                    offlineBtn.classList.remove('active');
                    showToast('Offline mode disabled', 'info');
                }
                
                renderPlaylist();
            }
            
            function cacheTracksForOffline() {
                if (tracks.length === 0) {
                    showToast('No tracks to cache for offline playback', 'warning');
                    return;
                }
                
                offlineProgress.style.display = 'flex';
                let cachedCount = 0;
                
                tracks.forEach((track, index) => {
                    setTimeout(() => {
                        if (!track.offline) {
                            track.offline = true;
                            cachedCount++;
                            
                            const progress = (cachedCount / tracks.length) * 100;
                            offlineProgressBar.style.width = `${progress}%`;
                            
                            if (cachedCount === tracks.length) {
                                setTimeout(() => {
                                    offlineProgress.style.display = 'none';
                                    showToast(`All ${cachedCount} tracks cached for offline playback`, 'success');
                                }, 500);
                            }
                        }
                    }, index * 300);
                });
            }
            
            function getFileFormat(file) {
                const extension = file.name.split('.').pop().toLowerCase();
                const mimeType = file.type.toLowerCase();
                
                for (const [mime, format] of Object.entries(SUPPORTED_FORMATS)) {
                    if (mimeType.includes(mime)) {
                        return format;
                    }
                }
                
                if (SUPPORTED_FORMATS[extension]) {
                    return SUPPORTED_FORMATS[extension];
                }
                
                return null;
            }
            
            function validateAudioFile(file) {
                const format = getFileFormat(file);
                
                if (!format) {
                    showToast(`Unsupported format: ${file.name}`, 'warning');
                    return false;
                }
                
                if (file.size > 100 * 1024 * 1024) {
                    showToast(`File too large: ${file.name} (${(file.size / (1024 * 1024)).toFixed(1)}MB)`, 'warning');
                    return false;
                }
                
                return true;
            }
            
            function togglePlay() {
                if (tracks.length === 0) return;
                
                if (isPlaying) {
                    pauseAudio();
                } else {
                    playAudio();
                }
            }
            
            function playAudio() {
                if (tracks.length === 0) return;
                
                if (!audioPlayer.src || audioPlayer.src !== tracks[currentTrackIndex].src) {
                    audioPlayer.src = tracks[currentTrackIndex].src;
                    updateTrackInfo();
                }
                
                audioPlayer.play().catch(error => {
                    showToast(`Cannot play: ${tracks[currentTrackIndex].title}`, 'error');
                    console.error('Playback error:', error);
                });
                
                isPlaying = true;
                playBtn.innerHTML = '<i class="fas fa-pause"></i>';
                albumArtContainer.classList.add('playing');
                highlightCurrentTrack();
            }
            
            function pauseAudio() {
                audioPlayer.pause();
                isPlaying = false;
                playBtn.innerHTML = '<i class="fas fa-play"></i>';
                albumArtContainer.classList.remove('playing');
            }
            
            function playPrevious() {
                if (tracks.length === 0) return;
                
                currentTrackIndex = (currentTrackIndex - 1 + tracks.length) % tracks.length;
                playAudio();
                highlightCurrentTrack();
            }
            
            function playNext() {
                if (tracks.length === 0) return;
                
                if (isShuffled) {
                    currentTrackIndex = Math.floor(Math.random() * tracks.length);
                } else {
                    currentTrackIndex = (currentTrackIndex + 1) % tracks.length;
                }
                playAudio();
                highlightCurrentTrack();
            }
            
            function handleTrackEnd() {
                if (isRepeating) {
                    audioPlayer.currentTime = 0;
                    audioPlayer.play();
                    highlightCurrentTrack();
                } else {
                    playNext();
                }
            }
            
            function handleAudioError() {
                showToast(`Error playing: ${tracks[currentTrackIndex]?.title || 'current track'}`, 'error');
                playNext();
            }
            
            function toggleShuffle() {
                isShuffled = !isShuffled;
                shuffleBtn.style.color = isShuffled ? '#2E97F2' : 'white';
                showToast(isShuffled ? 'Shuffle enabled' : 'Shuffle disabled', 'success');
            }
            
            function toggleRepeat() {
                isRepeating = !isRepeating;
                repeatBtn.style.color = isRepeating ? '#2E97F2' : 'white';
                showToast(isRepeating ? 'Repeat enabled' : 'Repeat disabled', 'success');
            }
            
            function setProgress(e) {
                if (tracks.length === 0) return;
                
                const width = this.clientWidth;
                const clickX = e.offsetX;
                const duration = audioPlayer.duration;
                
                audioPlayer.currentTime = (clickX / width) * duration;
            }
            
            function updateProgress() {
                if (tracks.length === 0) return;
                
                const { currentTime, duration } = audioPlayer;
                const progressPercent = (currentTime / duration) * 100;
                progress.style.width = `${progressPercent}%`;
                
                currentTimeEl.textContent = formatTime(currentTime);
            }
            
            function updateDuration() {
                durationEl.textContent = formatTime(audioPlayer.duration);
            }
            
            function setVolume() {
                audioPlayer.volume = volumeSlider.value / 100;
            }
            
            function updateTrackInfo() {
                if (tracks.length === 0) return;
                
                const track = tracks[currentTrackIndex];
                songTitle.textContent = track.title;
                songArtist.textContent = track.artist;
            }
            
            function formatTime(seconds) {
                if (isNaN(seconds)) return "0:00";
                
                const minutes = Math.floor(seconds / 60);
                const secs = Math.floor(seconds % 60);
                return `${minutes}:${secs < 10 ? '0' : ''}${secs}`;
            }
            
            function highlightCurrentTrack() {
                const items = document.querySelectorAll('.playlist-item');
                items.forEach((item, index) => {
                    if (index === currentTrackIndex) {
                        item.classList.add('active');
                    } else {
                        item.classList.remove('active');
                    }
                });
            }
            
            function renderPlaylist() {
                playlistItems.innerHTML = '';
                
                if (tracks.length === 0) {
                    playlistItems.innerHTML = `
                        <div class="empty-playlist">
                            <i class="fas fa-music"></i>
                            <p>Your playlist is empty</p>
                            <p>Add some songs to get started</p>
                        </div>
                    `;
                    return;
                }
                
                tracks.forEach((track, index) => {
                    const item = document.createElement('div');
                    item.className = `playlist-item ${index === currentTrackIndex ? 'active' : ''} ${track.offline ? 'offline' : ''}`;
                    item.draggable = true;
                    
                    const offlineBadge = track.offline ? '<span class="offline-badge"><i class="fas fa-check"></i> Offline</span>' : '';
                    
                    item.innerHTML = `
                        <div class="drag-handle" title="Drag to reorder">
                            <i class="fas fa-grip-lines"></i>
                        </div>
                        <div class="playlist-info">
                            <div class="playlist-title">
                                ${track.title}
                                <span class="format-badge">${track.format}</span>
                                ${offlineBadge}
                            </div>
                            <div class="playlist-artist">${track.artist}</div>
                        </div>
                        <div class="playlist-duration">${track.duration}</div>
                        <button class="remove-btn" title="Remove song">
                            <i class="fas fa-times"></i>
                        </button>
                    `;
                    
                    // Add drag and drop event listeners
                    item.addEventListener('dragstart', handleDragStart);
                    item.addEventListener('dragover', handleDragOver);
                    item.addEventListener('dragenter', handleDragEnter);
                    item.addEventListener('dragleave', handleDragLeave);
                    item.addEventListener('drop', handleDrop);
                    item.addEventListener('dragend', handleDragEnd);
                    
                    // Play song when clicked
                    item.addEventListener('click', (e) => {
                        if (!e.target.classList.contains('remove-btn') && 
                            !e.target.classList.contains('drag-handle') &&
                            !e.target.parentElement.classList.contains('drag-handle')) {
                            currentTrackIndex = index;
                            playAudio();
                            highlightCurrentTrack();
                        }
                    });
                    
                    // Remove song when remove button is clicked
                    const removeBtn = item.querySelector('.remove-btn');
                    removeBtn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        removeTrack(index);
                    });
                    
                    playlistItems.appendChild(item);
                });
            }
            
            // Drag and Drop Functions
            function handleDragStart(e) {
                dragSrcElement = this;
                e.dataTransfer.effectAllowed = 'move';
                e.dataTransfer.setData('text/html', this.innerHTML);
                this.classList.add('dragging');
            }
            
            function handleDragOver(e) {
                if (e.preventDefault) {
                    e.preventDefault();
                }
                e.dataTransfer.dropEffect = 'move';
                return false;
            }
            
            function handleDragEnter(e) {
                this.classList.add('drag-over');
            }
            
            function handleDragLeave(e) {
                this.classList.remove('drag-over');
            }
            
            function handleDrop(e) {
                if (e.stopPropagation) {
                    e.stopPropagation();
                }
                
                if (dragSrcElement !== this) {
                    const fromIndex = Array.from(playlistItems.children).indexOf(dragSrcElement);
                    const toIndex = Array.from(playlistItems.children).indexOf(this);
                    
                    // Reorder tracks array
                    const [movedTrack] = tracks.splice(fromIndex, 1);
                    tracks.splice(toIndex, 0, movedTrack);
                    
                    // Update currentTrackIndex if needed
                    if (currentTrackIndex === fromIndex) {
                        currentTrackIndex = toIndex;
                    } else if (currentTrackIndex > fromIndex && currentTrackIndex <= toIndex) {
                        currentTrackIndex--;
                    } else if (currentTrackIndex < fromIndex && currentTrackIndex >= toIndex) {
                        currentTrackIndex++;
                    }
                    
                    renderPlaylist();
                    highlightCurrentTrack();
                }
                
                return false;
            }
            
            function handleDragEnd(e) {
                const items = document.querySelectorAll('.playlist-item');
                items.forEach(item => {
                    item.classList.remove('dragging');
                    item.classList.remove('drag-over');
                });
            }
            
            // FIXED: removeTrack function with playback state preservation
            function removeTrack(index) {
                if (tracks.length === 0) return;
                
                // Store current playback state
                const wasPlaying = isPlaying;
                const currentTime = audioPlayer.currentTime;
                const currentSrc = audioPlayer.src;
                const isRemovingCurrentTrack = index === currentTrackIndex;
                
                // If we're removing the currently playing track
                if (isRemovingCurrentTrack) {
                    if (isPlaying) {
                        audioPlayer.pause();
                        isPlaying = false;
                        playBtn.innerHTML = '<i class="fas fa-play"></i>';
                        albumArtContainer.classList.remove('playing');
                    }
                    
                    // If it's the last track
                    if (tracks.length === 1) {
                        currentTrackIndex = 0;
                        audioPlayer.src = '';
                        updateTrackInfo();
                    } 
                    // If it's the last track in the playlist
                    else if (currentTrackIndex === tracks.length - 1) {
                        currentTrackIndex = 0;
                    }
                } 
                // If we're removing a track that comes before the current one
                else if (index < currentTrackIndex) {
                    currentTrackIndex--;
                }
                
                // Remove the track from the array
                tracks.splice(index, 1);
                
                // Re-render the playlist
                renderPlaylist();
                highlightCurrentTrack();
                
                // If we have tracks and the current one is valid, update the player
                if (tracks.length > 0 && currentTrackIndex < tracks.length) {
                    if (wasPlaying && !isRemovingCurrentTrack) {
                        // If we weren't removing the current track, restore playback
                        audioPlayer.src = tracks[currentTrackIndex].src;
                        audioPlayer.currentTime = currentTime;
                        audioPlayer.play().catch(e => console.log('Auto-play prevented'));
                        updateTrackInfo();
                    } else if (isRemovingCurrentTrack && wasPlaying) {
                        // If we removed the current track but were playing, start new track
                        audioPlayer.src = tracks[currentTrackIndex].src;
                        audioPlayer.play().catch(e => console.log('Auto-play prevented'));
                        updateTrackInfo();
                    } else {
                        // Just update the source
                        audioPlayer.src = tracks[currentTrackIndex].src;
                        updateTrackInfo();
                    }
                }
            }
            
            function clearPlaylist() {
                if (tracks.length === 0) return;
                
                // Stop playback
                if (isPlaying) {
                    audioPlayer.pause();
                    isPlaying = false;
                    playBtn.innerHTML = '<i class="fas fa-play"></i>';
                    albumArtContainer.classList.remove('playing');
                }
                
                // Clear tracks
                tracks = [];
                currentTrackIndex = 0;
                audioPlayer.src = '';
                
                // Update UI
                updateTrackInfo();
                renderPlaylist();
                songTitle.textContent = 'Select a song';
                songArtist.textContent = 'Artist name';
                
                showToast('Playlist cleared', 'success');
            }
            
            function handleFileUpload(e) {
                const files = e.target.files;
                let validFilesCount = 0;
                let invalidFilesCount = 0;
                
                for (let i = 0; i < files.length; i++) {
                    const file = files[i];
                    
                    if (validateAudioFile(file)) {
                        const url = URL.createObjectURL(file);
                        const format = getFileFormat(file);
                        const track = {
                            title: file.name.replace(/\.[^/.]+$/, ""),
                            artist: "Unknown Artist",
                            src: url,
                            duration: "0:00",
                            format: format,
                            offline: false,
                            dateAdded: Date.now()
                        };
                        
                        tracks.push(track);
                        validFilesCount++;
                    } else {
                        invalidFilesCount++;
                    }
                }
                
                if (validFilesCount > 0) {
                    renderPlaylist();
                    showToast(`Added ${validFilesCount} file(s) to playlist`, 'success');
                    
                    // Auto-enable offline mode if supported
                    if (supportsOffline && !isOfflineMode) {
                        showToast('Enable offline mode to cache tracks for offline playback', 'info');
                    }
                }
                
                if (invalidFilesCount > 0) {
                    showToast(`${invalidFilesCount} file(s) were not supported`, 'warning');
                }
                
                fileInput.value = '';
            }
        });
    </script>
</body>
</html>
